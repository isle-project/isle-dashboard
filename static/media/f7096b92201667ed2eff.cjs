"use strict";function _typeof(obj){return _typeof=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(obj2){return typeof obj2}:function(obj2){return obj2&&typeof Symbol=="function"&&obj2.constructor===Symbol&&obj2!==Symbol.prototype?"symbol":typeof obj2},_typeof(obj)}function _get(){return typeof Reflect!="undefined"&&Reflect.get?_get=Reflect.get:_get=function(target,property,receiver){var base=_superPropBase(target,property);if(!!base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(arguments.length<3?target:receiver):desc.value}},_get.apply(this,arguments)}function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&(object=_getPrototypeOf(object),object!==null););return object}function _inherits(subClass,superClass){if(typeof superClass!="function"&&superClass!==null)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o2,p2){return o2.__proto__=p2,o2},_setPrototypeOf(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call=="function"))return call;if(call!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(self)}function _assertThisInitialized(self){if(self===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _isNativeReflectConstruct(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o2){return o2.__proto__||Object.getPrototypeOf(o2)},_getPrototypeOf(o)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}Object.defineProperty(exports,"__esModule",{value:!0});var prosemirrorState=require("prosemirror-state"),prosemirrorModel=require("prosemirror-model"),prosemirrorTransform=require("prosemirror-transform"),nav=typeof navigator!="undefined"?navigator:null,doc=typeof document!="undefined"?document:null,agent=nav&&nav.userAgent||"",ie_edge=/Edge\/(\d+)/.exec(agent),ie_upto10=/MSIE \d/.exec(agent),ie_11up=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(agent),ie=!!(ie_upto10||ie_11up||ie_edge),ie_version=ie_upto10?document.documentMode:ie_11up?+ie_11up[1]:ie_edge?+ie_edge[1]:0,gecko=!ie&&/gecko\/(\d+)/i.test(agent);gecko&&+(/Firefox\/(\d+)/.exec(agent)||[0,0])[1];var _chrome=!ie&&/Chrome\/(\d+)/.exec(agent),chrome=!!_chrome,chrome_version=_chrome?+_chrome[1]:0,safari=!ie&&!!nav&&/Apple Computer/.test(nav.vendor),ios=safari&&(/Mobile\/\w+/.test(agent)||!!nav&&nav.maxTouchPoints>2),mac=ios||(nav?/Mac/.test(nav.platform):!1),android=/Android \d/.test(agent),webkit=!!doc&&"webkitFontSmoothing"in doc.documentElement.style,webkit_version=webkit?+(/\bAppleWebKit\/(\d+)/.exec(navigator.userAgent)||[0,0])[1]:0,domIndex=function(node){for(var index=0;;index++)if(node=node.previousSibling,!node)return index},parentNode=function(node){var parent=node.assignedSlot||node.parentNode;return parent&&parent.nodeType==11?parent.host:parent},reusedRange=null,textRange=function(node,from,to){var range=reusedRange||(reusedRange=document.createRange());return range.setEnd(node,to==null?node.nodeValue.length:to),range.setStart(node,from||0),range},isEquivalentPosition=function(node,off,targetNode,targetOff){return targetNode&&(scanFor(node,off,targetNode,targetOff,-1)||scanFor(node,off,targetNode,targetOff,1))},atomElements=/^(img|br|input|textarea|hr)$/i;function scanFor(node,off,targetNode,targetOff,dir){for(;;){if(node==targetNode&&off==targetOff)return!0;if(off==(dir<0?0:nodeSize(node))){var parent=node.parentNode;if(!parent||parent.nodeType!=1||hasBlockDesc(node)||atomElements.test(node.nodeName)||node.contentEditable=="false")return!1;off=domIndex(node)+(dir<0?0:1),node=parent}else if(node.nodeType==1){if(node=node.childNodes[off+(dir<0?-1:0)],node.contentEditable=="false")return!1;off=dir<0?nodeSize(node):0}else return!1}}function nodeSize(node){return node.nodeType==3?node.nodeValue.length:node.childNodes.length}function isOnEdge(node,offset,parent){for(var atStart=offset==0,atEnd=offset==nodeSize(node);atStart||atEnd;){if(node==parent)return!0;var index=domIndex(node);if(node=node.parentNode,!node)return!1;atStart=atStart&&index==0,atEnd=atEnd&&index==nodeSize(node)}}function hasBlockDesc(dom){for(var desc,cur=dom;cur&&!(desc=cur.pmViewDesc);cur=cur.parentNode);return desc&&desc.node&&desc.node.isBlock&&(desc.dom==dom||desc.contentDOM==dom)}var selectionCollapsed=function(domSel){var collapsed=domSel.isCollapsed;return collapsed&&chrome&&domSel.rangeCount&&!domSel.getRangeAt(0).collapsed&&(collapsed=!1),collapsed};function keyEvent(keyCode,key){var event=document.createEvent("Event");return event.initEvent("keydown",!0,!0),event.keyCode=keyCode,event.key=event.code=key,event}function windowRect(doc2){return{left:0,right:doc2.documentElement.clientWidth,top:0,bottom:doc2.documentElement.clientHeight}}function getSide(value,side){return typeof value=="number"?value:value[side]}function clientRect(node){var rect=node.getBoundingClientRect(),scaleX=rect.width/node.offsetWidth||1,scaleY=rect.height/node.offsetHeight||1;return{left:rect.left,right:rect.left+node.clientWidth*scaleX,top:rect.top,bottom:rect.top+node.clientHeight*scaleY}}function scrollRectIntoView(view,rect,startDOM){for(var scrollThreshold=view.someProp("scrollThreshold")||0,scrollMargin=view.someProp("scrollMargin")||5,doc2=view.dom.ownerDocument,parent=startDOM||view.dom;parent;parent=parentNode(parent))if(parent.nodeType==1){var elt=parent,atTop=elt==doc2.body,bounding=atTop?windowRect(doc2):clientRect(elt),moveX=0,moveY=0;if(rect.top<bounding.top+getSide(scrollThreshold,"top")?moveY=-(bounding.top-rect.top+getSide(scrollMargin,"top")):rect.bottom>bounding.bottom-getSide(scrollThreshold,"bottom")&&(moveY=rect.bottom-bounding.bottom+getSide(scrollMargin,"bottom")),rect.left<bounding.left+getSide(scrollThreshold,"left")?moveX=-(bounding.left-rect.left+getSide(scrollMargin,"left")):rect.right>bounding.right-getSide(scrollThreshold,"right")&&(moveX=rect.right-bounding.right+getSide(scrollMargin,"right")),moveX||moveY)if(atTop)doc2.defaultView.scrollBy(moveX,moveY);else{var startX=elt.scrollLeft,startY=elt.scrollTop;moveY&&(elt.scrollTop+=moveY),moveX&&(elt.scrollLeft+=moveX);var dX=elt.scrollLeft-startX,dY=elt.scrollTop-startY;rect={left:rect.left-dX,top:rect.top-dY,right:rect.right-dX,bottom:rect.bottom-dY}}if(atTop)break}}function storeScrollPos(view){for(var rect=view.dom.getBoundingClientRect(),startY=Math.max(0,rect.top),refDOM,refTop,x=(rect.left+rect.right)/2,y=startY+1;y<Math.min(innerHeight,rect.bottom);y+=5){var dom=view.root.elementFromPoint(x,y);if(!(!dom||dom==view.dom||!view.dom.contains(dom))){var localRect=dom.getBoundingClientRect();if(localRect.top>=startY-20){refDOM=dom,refTop=localRect.top;break}}}return{refDOM,refTop,stack:scrollStack(view.dom)}}function scrollStack(dom){for(var stack=[],doc2=dom.ownerDocument,cur=dom;cur&&(stack.push({dom:cur,top:cur.scrollTop,left:cur.scrollLeft}),dom!=doc2);cur=parentNode(cur));return stack}function resetScrollPos(_ref){var refDOM=_ref.refDOM,refTop=_ref.refTop,stack=_ref.stack,newRefTop=refDOM?refDOM.getBoundingClientRect().top:0;restoreScrollStack(stack,newRefTop==0?0:newRefTop-refTop)}function restoreScrollStack(stack,dTop){for(var i=0;i<stack.length;i++){var _stack$i=stack[i],dom=_stack$i.dom,top=_stack$i.top,left=_stack$i.left;dom.scrollTop!=top+dTop&&(dom.scrollTop=top+dTop),dom.scrollLeft!=left&&(dom.scrollLeft=left)}}var preventScrollSupported=null;function focusPreventScroll(dom){if(dom.setActive)return dom.setActive();if(preventScrollSupported)return dom.focus(preventScrollSupported);var stored=scrollStack(dom);dom.focus(preventScrollSupported==null?{get preventScroll(){return preventScrollSupported={preventScroll:!0},!0}}:void 0),preventScrollSupported||(preventScrollSupported=!1,restoreScrollStack(stored,0))}function findOffsetInNode(node,coords){for(var closest,dxClosest=2e8,coordsClosest,offset=0,rowBot=coords.top,rowTop=coords.top,child=node.firstChild,childIndex=0;child;child=child.nextSibling,childIndex++){var rects=void 0;if(child.nodeType==1)rects=child.getClientRects();else if(child.nodeType==3)rects=textRange(child).getClientRects();else continue;for(var i=0;i<rects.length;i++){var rect=rects[i];if(rect.top<=rowBot&&rect.bottom>=rowTop){rowBot=Math.max(rect.bottom,rowBot),rowTop=Math.min(rect.top,rowTop);var dx=rect.left>coords.left?rect.left-coords.left:rect.right<coords.left?coords.left-rect.right:0;if(dx<dxClosest){closest=child,dxClosest=dx,coordsClosest=dx&&closest.nodeType==3?{left:rect.right<coords.left?rect.right:rect.left,top:coords.top}:coords,child.nodeType==1&&dx&&(offset=childIndex+(coords.left>=(rect.left+rect.right)/2?1:0));continue}}!closest&&(coords.left>=rect.right&&coords.top>=rect.top||coords.left>=rect.left&&coords.top>=rect.bottom)&&(offset=childIndex+1)}}return closest&&closest.nodeType==3?findOffsetInText(closest,coordsClosest):!closest||dxClosest&&closest.nodeType==1?{node,offset}:findOffsetInNode(closest,coordsClosest)}function findOffsetInText(node,coords){for(var len=node.nodeValue.length,range=document.createRange(),i=0;i<len;i++){range.setEnd(node,i+1),range.setStart(node,i);var rect=singleRect(range,1);if(rect.top!=rect.bottom&&inRect(coords,rect))return{node,offset:i+(coords.left>=(rect.left+rect.right)/2?1:0)}}return{node,offset:0}}function inRect(coords,rect){return coords.left>=rect.left-1&&coords.left<=rect.right+1&&coords.top>=rect.top-1&&coords.top<=rect.bottom+1}function targetKludge(dom,coords){var parent=dom.parentNode;return parent&&/^li$/i.test(parent.nodeName)&&coords.left<dom.getBoundingClientRect().left?parent:dom}function posFromElement(view,elt,coords){var _findOffsetInNode=findOffsetInNode(elt,coords),node=_findOffsetInNode.node,offset=_findOffsetInNode.offset,bias=-1;if(node.nodeType==1&&!node.firstChild){var rect=node.getBoundingClientRect();bias=rect.left!=rect.right&&coords.left>(rect.left+rect.right)/2?1:-1}return view.docView.posFromDOM(node,offset,bias)}function posFromCaret(view,node,offset,coords){for(var outside=-1,cur=node;cur!=view.dom;){var desc=view.docView.nearestDesc(cur,!0);if(!desc)return null;if(desc.node.isBlock&&desc.parent){var rect=desc.dom.getBoundingClientRect();if(rect.left>coords.left||rect.top>coords.top)outside=desc.posBefore;else if(rect.right<coords.left||rect.bottom<coords.top)outside=desc.posAfter;else break}cur=desc.dom.parentNode}return outside>-1?outside:view.docView.posFromDOM(node,offset,1)}function elementFromPoint(element,coords,box){var len=element.childNodes.length;if(len&&box.top<box.bottom)for(var startI=Math.max(0,Math.min(len-1,Math.floor(len*(coords.top-box.top)/(box.bottom-box.top))-2)),i=startI;;){var child=element.childNodes[i];if(child.nodeType==1)for(var rects=child.getClientRects(),j=0;j<rects.length;j++){var rect=rects[j];if(inRect(coords,rect))return elementFromPoint(child,coords,rect)}if((i=(i+1)%len)==startI)break}return element}function _posAtCoords(view,coords){var doc2=view.dom.ownerDocument,node,offset=0;if(doc2.caretPositionFromPoint)try{var _pos=doc2.caretPositionFromPoint(coords.left,coords.top);_pos&&(node=_pos.offsetNode,offset=_pos.offset)}catch(_){}if(!node&&doc2.caretRangeFromPoint){var range=doc2.caretRangeFromPoint(coords.left,coords.top);range&&(node=range.startContainer,offset=range.startOffset)}var elt=(view.root.elementFromPoint?view.root:doc2).elementFromPoint(coords.left,coords.top),pos;if(!elt||!view.dom.contains(elt.nodeType!=1?elt.parentNode:elt)){var box=view.dom.getBoundingClientRect();if(!inRect(coords,box)||(elt=elementFromPoint(view.dom,coords,box),!elt))return null}if(safari)for(var p=elt;node&&p;p=parentNode(p))p.draggable&&(node=void 0);if(elt=targetKludge(elt,coords),node){if(gecko&&node.nodeType==1&&(offset=Math.min(offset,node.childNodes.length),offset<node.childNodes.length)){var next=node.childNodes[offset],_box;next.nodeName=="IMG"&&(_box=next.getBoundingClientRect()).right<=coords.left&&_box.bottom>coords.top&&offset++}node==view.dom&&offset==node.childNodes.length-1&&node.lastChild.nodeType==1&&coords.top>node.lastChild.getBoundingClientRect().bottom?pos=view.state.doc.content.size:(offset==0||node.nodeType!=1||node.childNodes[offset-1].nodeName!="BR")&&(pos=posFromCaret(view,node,offset,coords))}pos==null&&(pos=posFromElement(view,elt,coords));var desc=view.docView.nearestDesc(elt,!0);return{pos,inside:desc?desc.posAtStart-desc.border:-1}}function singleRect(target,bias){var rects=target.getClientRects();return rects.length?rects[bias<0?0:rects.length-1]:target.getBoundingClientRect()}var BIDI=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;function _coordsAtPos(view,pos,side){var _view$docView$domFrom=view.docView.domFromPos(pos,side<0?-1:1),node=_view$docView$domFrom.node,offset=_view$docView$domFrom.offset,supportEmptyRange=webkit||gecko;if(node.nodeType==3)if(supportEmptyRange&&(BIDI.test(node.nodeValue)||(side<0?!offset:offset==node.nodeValue.length))){var rect=singleRect(textRange(node,offset,offset),side);if(gecko&&offset&&/\s/.test(node.nodeValue[offset-1])&&offset<node.nodeValue.length){var rectBefore=singleRect(textRange(node,offset-1,offset-1),-1);if(rectBefore.top==rect.top){var rectAfter=singleRect(textRange(node,offset,offset+1),-1);if(rectAfter.top!=rect.top)return flattenV(rectAfter,rectAfter.left<rectBefore.left)}}return rect}else{var from=offset,to=offset,takeSide=side<0?1:-1;return side<0&&!offset?(to++,takeSide=-1):side>=0&&offset==node.nodeValue.length?(from--,takeSide=1):side<0?from--:to++,flattenV(singleRect(textRange(node,from,to),takeSide),takeSide<0)}if(!view.state.doc.resolve(pos).parent.inlineContent){if(offset&&(side<0||offset==nodeSize(node))){var before=node.childNodes[offset-1];if(before.nodeType==1)return flattenH(before.getBoundingClientRect(),!1)}if(offset<nodeSize(node)){var after=node.childNodes[offset];if(after.nodeType==1)return flattenH(after.getBoundingClientRect(),!0)}return flattenH(node.getBoundingClientRect(),side>=0)}if(offset&&(side<0||offset==nodeSize(node))){var _before=node.childNodes[offset-1],target=_before.nodeType==3?textRange(_before,nodeSize(_before)-(supportEmptyRange?0:1)):_before.nodeType==1&&(_before.nodeName!="BR"||!_before.nextSibling)?_before:null;if(target)return flattenV(singleRect(target,1),!1)}if(offset<nodeSize(node)){for(var _after=node.childNodes[offset];_after.pmViewDesc&&_after.pmViewDesc.ignoreForCoords;)_after=_after.nextSibling;var _target=_after?_after.nodeType==3?textRange(_after,0,supportEmptyRange?0:1):_after.nodeType==1?_after:null:null;if(_target)return flattenV(singleRect(_target,-1),!0)}return flattenV(singleRect(node.nodeType==3?textRange(node):node,-side),side>=0)}function flattenV(rect,left){if(rect.width==0)return rect;var x=left?rect.left:rect.right;return{top:rect.top,bottom:rect.bottom,left:x,right:x}}function flattenH(rect,top){if(rect.height==0)return rect;var y=top?rect.top:rect.bottom;return{top:y,bottom:y,left:rect.left,right:rect.right}}function withFlushedState(view,state,f){var viewState=view.state,active=view.root.activeElement;viewState!=state&&view.updateState(state),active!=view.dom&&view.focus();try{return f()}finally{viewState!=state&&view.updateState(viewState),active!=view.dom&&active&&active.focus()}}function endOfTextblockVertical(view,state,dir){var sel=state.selection,$pos=dir=="up"?sel.$from:sel.$to;return withFlushedState(view,state,function(){for(var _view$docView$domFrom2=view.docView.domFromPos($pos.pos,dir=="up"?-1:1),dom=_view$docView$domFrom2.node;;){var nearest=view.docView.nearestDesc(dom,!0);if(!nearest)break;if(nearest.node.isBlock){dom=nearest.dom;break}dom=nearest.dom.parentNode}for(var coords=_coordsAtPos(view,$pos.pos,1),child=dom.firstChild;child;child=child.nextSibling){var boxes=void 0;if(child.nodeType==1)boxes=child.getClientRects();else if(child.nodeType==3)boxes=textRange(child,0,child.nodeValue.length).getClientRects();else continue;for(var i=0;i<boxes.length;i++){var box=boxes[i];if(box.bottom>box.top+1&&(dir=="up"?coords.top-box.top>(box.bottom-coords.top)*2:box.bottom-coords.bottom>(coords.bottom-box.top)*2))return!1}}return!0})}var maybeRTL=/[\u0590-\u08ac]/;function endOfTextblockHorizontal(view,state,dir){var $head=state.selection.$head;if(!$head.parent.isTextblock)return!1;var offset=$head.parentOffset,atStart=!offset,atEnd=offset==$head.parent.content.size,sel=view.domSelection();return!maybeRTL.test($head.parent.textContent)||!sel.modify?dir=="left"||dir=="backward"?atStart:atEnd:withFlushedState(view,state,function(){var oldRange=sel.getRangeAt(0),oldNode=sel.focusNode,oldOff=sel.focusOffset,oldBidiLevel=sel.caretBidiLevel;sel.modify("move",dir,"character");var parentDOM=$head.depth?view.docView.domAfterPos($head.before()):view.dom,result=!parentDOM.contains(sel.focusNode.nodeType==1?sel.focusNode:sel.focusNode.parentNode)||oldNode==sel.focusNode&&oldOff==sel.focusOffset;return sel.removeAllRanges(),sel.addRange(oldRange),oldBidiLevel!=null&&(sel.caretBidiLevel=oldBidiLevel),result})}var cachedState=null,cachedDir=null,cachedResult=!1;function _endOfTextblock(view,state,dir){return cachedState==state&&cachedDir==dir?cachedResult:(cachedState=state,cachedDir=dir,cachedResult=dir=="up"||dir=="down"?endOfTextblockVertical(view,state,dir):endOfTextblockHorizontal(view,state,dir))}var NOT_DIRTY=0,CHILD_DIRTY=1,CONTENT_DIRTY=2,NODE_DIRTY=3,ViewDesc=function(){function ViewDesc2(parent,children,dom,contentDOM){_classCallCheck(this,ViewDesc2),this.parent=parent,this.children=children,this.dom=dom,this.contentDOM=contentDOM,this.dirty=NOT_DIRTY,dom.pmViewDesc=this}return _createClass(ViewDesc2,[{key:"matchesWidget",value:function(widget){return!1}},{key:"matchesMark",value:function(mark){return!1}},{key:"matchesNode",value:function(node,outerDeco,innerDeco){return!1}},{key:"matchesHack",value:function(nodeName){return!1}},{key:"parseRule",value:function(){return null}},{key:"stopEvent",value:function(event){return!1}},{key:"size",get:function(){for(var size=0,i=0;i<this.children.length;i++)size+=this.children[i].size;return size}},{key:"border",get:function(){return 0}},{key:"destroy",value:function(){this.parent=void 0,this.dom.pmViewDesc==this&&(this.dom.pmViewDesc=void 0);for(var i=0;i<this.children.length;i++)this.children[i].destroy()}},{key:"posBeforeChild",value:function(child){for(var i=0,pos=this.posAtStart;;i++){var cur=this.children[i];if(cur==child)return pos;pos+=cur.size}}},{key:"posBefore",get:function(){return this.parent.posBeforeChild(this)}},{key:"posAtStart",get:function(){return this.parent?this.parent.posBeforeChild(this)+this.border:0}},{key:"posAfter",get:function(){return this.posBefore+this.size}},{key:"posAtEnd",get:function(){return this.posAtStart+this.size-2*this.border}},{key:"localPosFromDOM",value:function(dom,offset,bias){if(this.contentDOM&&this.contentDOM.contains(dom.nodeType==1?dom:dom.parentNode))if(bias<0){var domBefore,desc;if(dom==this.contentDOM)domBefore=dom.childNodes[offset-1];else{for(;dom.parentNode!=this.contentDOM;)dom=dom.parentNode;domBefore=dom.previousSibling}for(;domBefore&&!((desc=domBefore.pmViewDesc)&&desc.parent==this);)domBefore=domBefore.previousSibling;return domBefore?this.posBeforeChild(desc)+desc.size:this.posAtStart}else{var domAfter,_desc;if(dom==this.contentDOM)domAfter=dom.childNodes[offset];else{for(;dom.parentNode!=this.contentDOM;)dom=dom.parentNode;domAfter=dom.nextSibling}for(;domAfter&&!((_desc=domAfter.pmViewDesc)&&_desc.parent==this);)domAfter=domAfter.nextSibling;return domAfter?this.posBeforeChild(_desc):this.posAtEnd}var atEnd;if(dom==this.dom&&this.contentDOM)atEnd=offset>domIndex(this.contentDOM);else if(this.contentDOM&&this.contentDOM!=this.dom&&this.dom.contains(this.contentDOM))atEnd=dom.compareDocumentPosition(this.contentDOM)&2;else if(this.dom.firstChild){if(offset==0)for(var search=dom;;search=search.parentNode){if(search==this.dom){atEnd=!1;break}if(search.previousSibling)break}if(atEnd==null&&offset==dom.childNodes.length)for(var _search=dom;;_search=_search.parentNode){if(_search==this.dom){atEnd=!0;break}if(_search.nextSibling)break}}return(atEnd==null?bias>0:atEnd)?this.posAtEnd:this.posAtStart}},{key:"nearestDesc",value:function(dom){for(var onlyNodes=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,first=!0,cur=dom;cur;cur=cur.parentNode){var desc=this.getDesc(cur),nodeDOM=void 0;if(desc&&(!onlyNodes||desc.node))if(first&&(nodeDOM=desc.nodeDOM)&&!(nodeDOM.nodeType==1?nodeDOM.contains(dom.nodeType==1?dom:dom.parentNode):nodeDOM==dom))first=!1;else return desc}}},{key:"getDesc",value:function(dom){for(var desc=dom.pmViewDesc,cur=desc;cur;cur=cur.parent)if(cur==this)return desc}},{key:"posFromDOM",value:function(dom,offset,bias){for(var scan=dom;scan;scan=scan.parentNode){var desc=this.getDesc(scan);if(desc)return desc.localPosFromDOM(dom,offset,bias)}return-1}},{key:"descAt",value:function(pos){for(var i=0,offset=0;i<this.children.length;i++){var child=this.children[i],end=offset+child.size;if(offset==pos&&end!=offset){for(;!child.border&&child.children.length;)child=child.children[0];return child}if(pos<end)return child.descAt(pos-offset-child.border);offset=end}}},{key:"domFromPos",value:function(pos,side){if(!this.contentDOM)return{node:this.dom,offset:0};for(var i=0,offset=0,curPos=0;i<this.children.length;i++){var child=this.children[i],end=curPos+child.size;if(end>pos||child instanceof TrailingHackViewDesc){offset=pos-curPos;break}curPos=end}if(offset)return this.children[i].domFromPos(offset-this.children[i].border,side);for(var prev;i&&!(prev=this.children[i-1]).size&&prev instanceof WidgetViewDesc&&prev.side>=0;i--);if(side<=0){for(var _prev,enter=!0;_prev=i?this.children[i-1]:null,!(!_prev||_prev.dom.parentNode==this.contentDOM);i--,enter=!1);return _prev&&side&&enter&&!_prev.border&&!_prev.domAtom?_prev.domFromPos(_prev.size,side):{node:this.contentDOM,offset:_prev?domIndex(_prev.dom)+1:0}}else{for(var next,_enter=!0;next=i<this.children.length?this.children[i]:null,!(!next||next.dom.parentNode==this.contentDOM);i++,_enter=!1);return next&&_enter&&!next.border&&!next.domAtom?next.domFromPos(0,side):{node:this.contentDOM,offset:next?domIndex(next.dom):this.contentDOM.childNodes.length}}}},{key:"parseRange",value:function(from,to){var base=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;if(this.children.length==0)return{node:this.contentDOM,from,to,fromOffset:0,toOffset:this.contentDOM.childNodes.length};for(var fromOffset=-1,toOffset=-1,offset=base,i=0;;i++){var child=this.children[i],end=offset+child.size;if(fromOffset==-1&&from<=end){var childBase=offset+child.border;if(from>=childBase&&to<=end-child.border&&child.node&&child.contentDOM&&this.contentDOM.contains(child.contentDOM))return child.parseRange(from,to,childBase);from=offset;for(var j=i;j>0;j--){var prev=this.children[j-1];if(prev.size&&prev.dom.parentNode==this.contentDOM&&!prev.emptyChildAt(1)){fromOffset=domIndex(prev.dom)+1;break}from-=prev.size}fromOffset==-1&&(fromOffset=0)}if(fromOffset>-1&&(end>to||i==this.children.length-1)){to=end;for(var _j=i+1;_j<this.children.length;_j++){var next=this.children[_j];if(next.size&&next.dom.parentNode==this.contentDOM&&!next.emptyChildAt(-1)){toOffset=domIndex(next.dom);break}to+=next.size}toOffset==-1&&(toOffset=this.contentDOM.childNodes.length);break}offset=end}return{node:this.contentDOM,from,to,fromOffset,toOffset}}},{key:"emptyChildAt",value:function(side){if(this.border||!this.contentDOM||!this.children.length)return!1;var child=this.children[side<0?0:this.children.length-1];return child.size==0||child.emptyChildAt(side)}},{key:"domAfterPos",value:function(pos){var _this$domFromPos=this.domFromPos(pos,0),node=_this$domFromPos.node,offset=_this$domFromPos.offset;if(node.nodeType!=1||offset==node.childNodes.length)throw new RangeError("No node after pos "+pos);return node.childNodes[offset]}},{key:"setSelection",value:function(anchor,head,root){for(var force=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,from=Math.min(anchor,head),to=Math.max(anchor,head),i=0,offset=0;i<this.children.length;i++){var child=this.children[i],end=offset+child.size;if(from>offset&&to<end)return child.setSelection(anchor-offset-child.border,head-offset-child.border,root,force);offset=end}var anchorDOM=this.domFromPos(anchor,anchor?-1:1),headDOM=head==anchor?anchorDOM:this.domFromPos(head,head?-1:1),domSel=root.getSelection(),brKludge=!1;if((gecko||safari)&&anchor==head){var _anchorDOM=anchorDOM,node=_anchorDOM.node,_offset=_anchorDOM.offset;if(node.nodeType==3){if(brKludge=!!(_offset&&node.nodeValue[_offset-1]==`
`),brKludge&&_offset==node.nodeValue.length)for(var scan=node,after;scan;scan=scan.parentNode){if(after=scan.nextSibling){after.nodeName=="BR"&&(anchorDOM=headDOM={node:after.parentNode,offset:domIndex(after)+1});break}var desc=scan.pmViewDesc;if(desc&&desc.node&&desc.node.isBlock)break}}else{var prev=node.childNodes[_offset-1];brKludge=prev&&(prev.nodeName=="BR"||prev.contentEditable=="false")}}if(gecko&&domSel.focusNode&&domSel.focusNode!=headDOM.node&&domSel.focusNode.nodeType==1){var _after2=domSel.focusNode.childNodes[domSel.focusOffset];_after2&&_after2.contentEditable=="false"&&(force=!0)}if(!(!(force||brKludge&&safari)&&isEquivalentPosition(anchorDOM.node,anchorDOM.offset,domSel.anchorNode,domSel.anchorOffset)&&isEquivalentPosition(headDOM.node,headDOM.offset,domSel.focusNode,domSel.focusOffset))){var domSelExtended=!1;if((domSel.extend||anchor==head)&&!brKludge){domSel.collapse(anchorDOM.node,anchorDOM.offset);try{anchor!=head&&domSel.extend(headDOM.node,headDOM.offset),domSelExtended=!0}catch(err){if(!(err instanceof DOMException))throw err}}if(!domSelExtended){if(anchor>head){var tmp=anchorDOM;anchorDOM=headDOM,headDOM=tmp}var range=document.createRange();range.setEnd(headDOM.node,headDOM.offset),range.setStart(anchorDOM.node,anchorDOM.offset),domSel.removeAllRanges(),domSel.addRange(range)}}}},{key:"ignoreMutation",value:function(mutation){return!this.contentDOM&&mutation.type!="selection"}},{key:"contentLost",get:function(){return this.contentDOM&&this.contentDOM!=this.dom&&!this.dom.contains(this.contentDOM)}},{key:"markDirty",value:function(from,to){for(var offset=0,i=0;i<this.children.length;i++){var child=this.children[i],end=offset+child.size;if(offset==end?from<=end&&to>=offset:from<end&&to>offset){var startInside=offset+child.border,endInside=end-child.border;if(from>=startInside&&to<=endInside){this.dirty=from==offset||to==end?CONTENT_DIRTY:CHILD_DIRTY,from==startInside&&to==endInside&&(child.contentLost||child.dom.parentNode!=this.contentDOM)?child.dirty=NODE_DIRTY:child.markDirty(from-startInside,to-startInside);return}else child.dirty=child.dom==child.contentDOM&&child.dom.parentNode==this.contentDOM&&!child.children.length?CONTENT_DIRTY:NODE_DIRTY}offset=end}this.dirty=CONTENT_DIRTY}},{key:"markParentsDirty",value:function(){for(var level=1,node=this.parent;node;node=node.parent,level++){var dirty=level==1?CONTENT_DIRTY:CHILD_DIRTY;node.dirty<dirty&&(node.dirty=dirty)}}},{key:"domAtom",get:function(){return!1}},{key:"ignoreForCoords",get:function(){return!1}}]),ViewDesc2}(),WidgetViewDesc=function(_ViewDesc){_inherits(WidgetViewDesc2,_ViewDesc);var _super=_createSuper(WidgetViewDesc2);function WidgetViewDesc2(parent,widget,view,pos){var _this;_classCallCheck(this,WidgetViewDesc2);var self,dom=widget.type.toDOM;if(typeof dom=="function"&&(dom=dom(view,function(){if(!self)return pos;if(self.parent)return self.parent.posBeforeChild(self)})),!widget.type.spec.raw){if(dom.nodeType!=1){var wrap=document.createElement("span");wrap.appendChild(dom),dom=wrap}dom.contentEditable="false",dom.classList.add("ProseMirror-widget")}return _this=_super.call(this,parent,[],dom,null),_this.widget=widget,_this.widget=widget,self=_assertThisInitialized(_this),_this}return _createClass(WidgetViewDesc2,[{key:"matchesWidget",value:function(widget){return this.dirty==NOT_DIRTY&&widget.type.eq(this.widget.type)}},{key:"parseRule",value:function(){return{ignore:!0}}},{key:"stopEvent",value:function(event){var stop=this.widget.spec.stopEvent;return stop?stop(event):!1}},{key:"ignoreMutation",value:function(mutation){return mutation.type!="selection"||this.widget.spec.ignoreSelection}},{key:"destroy",value:function(){this.widget.type.destroy(this.dom),_get(_getPrototypeOf(WidgetViewDesc2.prototype),"destroy",this).call(this)}},{key:"domAtom",get:function(){return!0}},{key:"side",get:function(){return this.widget.type.side}}]),WidgetViewDesc2}(ViewDesc),CompositionViewDesc=function(_ViewDesc2){_inherits(CompositionViewDesc2,_ViewDesc2);var _super2=_createSuper(CompositionViewDesc2);function CompositionViewDesc2(parent,dom,textDOM,text){var _this2;return _classCallCheck(this,CompositionViewDesc2),_this2=_super2.call(this,parent,[],dom,null),_this2.textDOM=textDOM,_this2.text=text,_this2}return _createClass(CompositionViewDesc2,[{key:"size",get:function(){return this.text.length}},{key:"localPosFromDOM",value:function(dom,offset){return dom!=this.textDOM?this.posAtStart+(offset?this.size:0):this.posAtStart+offset}},{key:"domFromPos",value:function(pos){return{node:this.textDOM,offset:pos}}},{key:"ignoreMutation",value:function(mut){return mut.type==="characterData"&&mut.target.nodeValue==mut.oldValue}}]),CompositionViewDesc2}(ViewDesc),MarkViewDesc=function(_ViewDesc3){_inherits(MarkViewDesc2,_ViewDesc3);var _super3=_createSuper(MarkViewDesc2);function MarkViewDesc2(parent,mark,dom,contentDOM){var _this3;return _classCallCheck(this,MarkViewDesc2),_this3=_super3.call(this,parent,[],dom,contentDOM),_this3.mark=mark,_this3}return _createClass(MarkViewDesc2,[{key:"parseRule",value:function(){return this.dirty&NODE_DIRTY||this.mark.type.spec.reparseInView?null:{mark:this.mark.type.name,attrs:this.mark.attrs,contentElement:this.contentDOM||void 0}}},{key:"matchesMark",value:function(mark){return this.dirty!=NODE_DIRTY&&this.mark.eq(mark)}},{key:"markDirty",value:function(from,to){if(_get(_getPrototypeOf(MarkViewDesc2.prototype),"markDirty",this).call(this,from,to),this.dirty!=NOT_DIRTY){for(var parent=this.parent;!parent.node;)parent=parent.parent;parent.dirty<this.dirty&&(parent.dirty=this.dirty),this.dirty=NOT_DIRTY}}},{key:"slice",value:function(from,to,view){var copy=MarkViewDesc2.create(this.parent,this.mark,!0,view),nodes=this.children,size=this.size;to<size&&(nodes=replaceNodes(nodes,to,size,view)),from>0&&(nodes=replaceNodes(nodes,0,from,view));for(var i=0;i<nodes.length;i++)nodes[i].parent=copy;return copy.children=nodes,copy}}],[{key:"create",value:function(parent,mark,inline,view){var custom=view.nodeViews[mark.type.name],spec=custom&&custom(mark,view,inline);return(!spec||!spec.dom)&&(spec=prosemirrorModel.DOMSerializer.renderSpec(document,mark.type.spec.toDOM(mark,inline))),new MarkViewDesc2(parent,mark,spec.dom,spec.contentDOM||spec.dom)}}]),MarkViewDesc2}(ViewDesc),NodeViewDesc=function(_ViewDesc4){_inherits(NodeViewDesc2,_ViewDesc4);var _super4=_createSuper(NodeViewDesc2);function NodeViewDesc2(parent,node,outerDeco,innerDeco,dom,contentDOM,nodeDOM,view,pos){var _this4;return _classCallCheck(this,NodeViewDesc2),_this4=_super4.call(this,parent,[],dom,contentDOM),_this4.node=node,_this4.outerDeco=outerDeco,_this4.innerDeco=innerDeco,_this4.nodeDOM=nodeDOM,contentDOM&&_this4.updateChildren(view,pos),_this4}return _createClass(NodeViewDesc2,[{key:"parseRule",value:function(){var _this5=this;if(this.node.type.spec.reparseInView)return null;var rule={node:this.node.type.name,attrs:this.node.attrs};if(this.node.type.whitespace=="pre"&&(rule.preserveWhitespace="full"),!this.contentDOM)rule.getContent=function(){return _this5.node.content};else if(!this.contentLost)rule.contentElement=this.contentDOM;else{for(var i=this.children.length-1;i>=0;i--){var child=this.children[i];if(this.dom.contains(child.dom.parentNode)){rule.contentElement=child.dom.parentNode;break}}rule.contentElement||(rule.getContent=function(){return prosemirrorModel.Fragment.empty})}return rule}},{key:"matchesNode",value:function(node,outerDeco,innerDeco){return this.dirty==NOT_DIRTY&&node.eq(this.node)&&sameOuterDeco(outerDeco,this.outerDeco)&&innerDeco.eq(this.innerDeco)}},{key:"size",get:function(){return this.node.nodeSize}},{key:"border",get:function(){return this.node.isLeaf?0:1}},{key:"updateChildren",value:function(view,pos){var _this6=this,inline=this.node.inlineContent,off=pos,composition=view.composing?this.localCompositionInfo(view,pos):null,localComposition=composition&&composition.pos>-1?composition:null,compositionInChild=composition&&composition.pos<0,updater=new ViewTreeUpdater(this,localComposition&&localComposition.node);iterDeco(this.node,this.innerDeco,function(widget,i,insideNode){widget.spec.marks?updater.syncToMarks(widget.spec.marks,inline,view):widget.type.side>=0&&!insideNode&&updater.syncToMarks(i==_this6.node.childCount?prosemirrorModel.Mark.none:_this6.node.child(i).marks,inline,view),updater.placeWidget(widget,view,off)},function(child,outerDeco,innerDeco,i){updater.syncToMarks(child.marks,inline,view);var compIndex;updater.findNodeMatch(child,outerDeco,innerDeco,i)||compositionInChild&&view.state.selection.from>off&&view.state.selection.to<off+child.nodeSize&&(compIndex=updater.findIndexWithChild(composition.node))>-1&&updater.updateNodeAt(child,outerDeco,innerDeco,compIndex,view)||updater.updateNextNode(child,outerDeco,innerDeco,view,i)||updater.addNode(child,outerDeco,innerDeco,view,off),off+=child.nodeSize}),updater.syncToMarks([],inline,view),this.node.isTextblock&&updater.addTextblockHacks(),updater.destroyRest(),(updater.changed||this.dirty==CONTENT_DIRTY)&&(localComposition&&this.protectLocalComposition(view,localComposition),renderDescs(this.contentDOM,this.children,view),ios&&iosHacks(this.dom))}},{key:"localCompositionInfo",value:function(view,pos){var _view$state$selection=view.state.selection,from=_view$state$selection.from,to=_view$state$selection.to;if(!(view.state.selection instanceof prosemirrorState.TextSelection)||from<pos||to>pos+this.node.content.size)return null;var sel=view.domSelection(),textNode=nearbyTextNode(sel.focusNode,sel.focusOffset);if(!textNode||!this.dom.contains(textNode.parentNode))return null;if(this.node.inlineContent){var text=textNode.nodeValue,textPos=findTextInFragment(this.node.content,text,from-pos,to-pos);return textPos<0?null:{node:textNode,pos:textPos,text}}else return{node:textNode,pos:-1,text:""}}},{key:"protectLocalComposition",value:function(view,_ref2){var node=_ref2.node,pos=_ref2.pos,text=_ref2.text;if(!this.getDesc(node)){for(var topNode=node;topNode.parentNode!=this.contentDOM;topNode=topNode.parentNode){for(;topNode.previousSibling;)topNode.parentNode.removeChild(topNode.previousSibling);for(;topNode.nextSibling;)topNode.parentNode.removeChild(topNode.nextSibling);topNode.pmViewDesc&&(topNode.pmViewDesc=void 0)}var desc=new CompositionViewDesc(this,topNode,node,text);view.input.compositionNodes.push(desc),this.children=replaceNodes(this.children,pos,pos+text.length,view,desc)}}},{key:"update",value:function(node,outerDeco,innerDeco,view){return this.dirty==NODE_DIRTY||!node.sameMarkup(this.node)?!1:(this.updateInner(node,outerDeco,innerDeco,view),!0)}},{key:"updateInner",value:function(node,outerDeco,innerDeco,view){this.updateOuterDeco(outerDeco),this.node=node,this.innerDeco=innerDeco,this.contentDOM&&this.updateChildren(view,this.posAtStart),this.dirty=NOT_DIRTY}},{key:"updateOuterDeco",value:function(outerDeco){if(!sameOuterDeco(outerDeco,this.outerDeco)){var needsWrap=this.nodeDOM.nodeType!=1,oldDOM=this.dom;this.dom=patchOuterDeco(this.dom,this.nodeDOM,computeOuterDeco(this.outerDeco,this.node,needsWrap),computeOuterDeco(outerDeco,this.node,needsWrap)),this.dom!=oldDOM&&(oldDOM.pmViewDesc=void 0,this.dom.pmViewDesc=this),this.outerDeco=outerDeco}}},{key:"selectNode",value:function(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.add("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&(this.dom.draggable=!0)}},{key:"deselectNode",value:function(){this.nodeDOM.nodeType==1&&this.nodeDOM.classList.remove("ProseMirror-selectednode"),(this.contentDOM||!this.node.type.spec.draggable)&&this.dom.removeAttribute("draggable")}},{key:"domAtom",get:function(){return this.node.isAtom}}],[{key:"create",value:function(parent,node,outerDeco,innerDeco,view,pos){var custom=view.nodeViews[node.type.name],descObj,spec=custom&&custom(node,view,function(){if(!descObj)return pos;if(descObj.parent)return descObj.parent.posBeforeChild(descObj)},outerDeco,innerDeco),dom=spec&&spec.dom,contentDOM=spec&&spec.contentDOM;if(node.isText){if(!dom)dom=document.createTextNode(node.text);else if(dom.nodeType!=3)throw new RangeError("Text must be rendered as a DOM text node")}else if(!dom){var _prosemirrorModel$DOM=prosemirrorModel.DOMSerializer.renderSpec(document,node.type.spec.toDOM(node));dom=_prosemirrorModel$DOM.dom,contentDOM=_prosemirrorModel$DOM.contentDOM}!contentDOM&&!node.isText&&dom.nodeName!="BR"&&(dom.hasAttribute("contenteditable")||(dom.contentEditable="false"),node.type.spec.draggable&&(dom.draggable=!0));var nodeDOM=dom;return dom=applyOuterDeco(dom,outerDeco,node),spec?descObj=new CustomNodeViewDesc(parent,node,outerDeco,innerDeco,dom,contentDOM||null,nodeDOM,spec,view,pos+1):node.isText?new TextViewDesc(parent,node,outerDeco,innerDeco,dom,nodeDOM,view):new NodeViewDesc2(parent,node,outerDeco,innerDeco,dom,contentDOM||null,nodeDOM,view,pos+1)}}]),NodeViewDesc2}(ViewDesc);function docViewDesc(doc2,outerDeco,innerDeco,dom,view){return applyOuterDeco(dom,outerDeco,doc2),new NodeViewDesc(void 0,doc2,outerDeco,innerDeco,dom,dom,dom,view,0)}var TextViewDesc=function(_NodeViewDesc){_inherits(TextViewDesc2,_NodeViewDesc);var _super5=_createSuper(TextViewDesc2);function TextViewDesc2(parent,node,outerDeco,innerDeco,dom,nodeDOM,view){return _classCallCheck(this,TextViewDesc2),_super5.call(this,parent,node,outerDeco,innerDeco,dom,null,nodeDOM,view,0)}return _createClass(TextViewDesc2,[{key:"parseRule",value:function(){for(var skip=this.nodeDOM.parentNode;skip&&skip!=this.dom&&!skip.pmIsDeco;)skip=skip.parentNode;return{skip:skip||!0}}},{key:"update",value:function(node,outerDeco,innerDeco,view){return this.dirty==NODE_DIRTY||this.dirty!=NOT_DIRTY&&!this.inParent()||!node.sameMarkup(this.node)?!1:(this.updateOuterDeco(outerDeco),(this.dirty!=NOT_DIRTY||node.text!=this.node.text)&&node.text!=this.nodeDOM.nodeValue&&(this.nodeDOM.nodeValue=node.text,view.trackWrites==this.nodeDOM&&(view.trackWrites=null)),this.node=node,this.dirty=NOT_DIRTY,!0)}},{key:"inParent",value:function(){for(var parentDOM=this.parent.contentDOM,n=this.nodeDOM;n;n=n.parentNode)if(n==parentDOM)return!0;return!1}},{key:"domFromPos",value:function(pos){return{node:this.nodeDOM,offset:pos}}},{key:"localPosFromDOM",value:function(dom,offset,bias){return dom==this.nodeDOM?this.posAtStart+Math.min(offset,this.node.text.length):_get(_getPrototypeOf(TextViewDesc2.prototype),"localPosFromDOM",this).call(this,dom,offset,bias)}},{key:"ignoreMutation",value:function(mutation){return mutation.type!="characterData"&&mutation.type!="selection"}},{key:"slice",value:function(from,to,view){var node=this.node.cut(from,to),dom=document.createTextNode(node.text);return new TextViewDesc2(this.parent,node,this.outerDeco,this.innerDeco,dom,dom,view)}},{key:"markDirty",value:function(from,to){_get(_getPrototypeOf(TextViewDesc2.prototype),"markDirty",this).call(this,from,to),this.dom!=this.nodeDOM&&(from==0||to==this.nodeDOM.nodeValue.length)&&(this.dirty=NODE_DIRTY)}},{key:"domAtom",get:function(){return!1}}]),TextViewDesc2}(NodeViewDesc),TrailingHackViewDesc=function(_ViewDesc5){_inherits(TrailingHackViewDesc2,_ViewDesc5);var _super6=_createSuper(TrailingHackViewDesc2);function TrailingHackViewDesc2(){return _classCallCheck(this,TrailingHackViewDesc2),_super6.apply(this,arguments)}return _createClass(TrailingHackViewDesc2,[{key:"parseRule",value:function(){return{ignore:!0}}},{key:"matchesHack",value:function(nodeName){return this.dirty==NOT_DIRTY&&this.dom.nodeName==nodeName}},{key:"domAtom",get:function(){return!0}},{key:"ignoreForCoords",get:function(){return this.dom.nodeName=="IMG"}}]),TrailingHackViewDesc2}(ViewDesc),CustomNodeViewDesc=function(_NodeViewDesc2){_inherits(CustomNodeViewDesc2,_NodeViewDesc2);var _super7=_createSuper(CustomNodeViewDesc2);function CustomNodeViewDesc2(parent,node,outerDeco,innerDeco,dom,contentDOM,nodeDOM,spec,view,pos){var _this7;return _classCallCheck(this,CustomNodeViewDesc2),_this7=_super7.call(this,parent,node,outerDeco,innerDeco,dom,contentDOM,nodeDOM,view,pos),_this7.spec=spec,_this7}return _createClass(CustomNodeViewDesc2,[{key:"update",value:function(node,outerDeco,innerDeco,view){if(this.dirty==NODE_DIRTY)return!1;if(this.spec.update){var result=this.spec.update(node,outerDeco,innerDeco);return result&&this.updateInner(node,outerDeco,innerDeco,view),result}else return!this.contentDOM&&!node.isLeaf?!1:_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"update",this).call(this,node,outerDeco,innerDeco,view)}},{key:"selectNode",value:function(){this.spec.selectNode?this.spec.selectNode():_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"selectNode",this).call(this)}},{key:"deselectNode",value:function(){this.spec.deselectNode?this.spec.deselectNode():_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"deselectNode",this).call(this)}},{key:"setSelection",value:function(anchor,head,root,force){this.spec.setSelection?this.spec.setSelection(anchor,head,root):_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"setSelection",this).call(this,anchor,head,root,force)}},{key:"destroy",value:function(){this.spec.destroy&&this.spec.destroy(),_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"destroy",this).call(this)}},{key:"stopEvent",value:function(event){return this.spec.stopEvent?this.spec.stopEvent(event):!1}},{key:"ignoreMutation",value:function(mutation){return this.spec.ignoreMutation?this.spec.ignoreMutation(mutation):_get(_getPrototypeOf(CustomNodeViewDesc2.prototype),"ignoreMutation",this).call(this,mutation)}}]),CustomNodeViewDesc2}(NodeViewDesc);function renderDescs(parentDOM,descs,view){for(var dom=parentDOM.firstChild,written=!1,i=0;i<descs.length;i++){var desc=descs[i],childDOM=desc.dom;if(childDOM.parentNode==parentDOM){for(;childDOM!=dom;)dom=rm(dom),written=!0;dom=dom.nextSibling}else written=!0,parentDOM.insertBefore(childDOM,dom);if(desc instanceof MarkViewDesc){var pos=dom?dom.previousSibling:parentDOM.lastChild;renderDescs(desc.contentDOM,desc.children,view),dom=pos?pos.nextSibling:parentDOM.firstChild}}for(;dom;)dom=rm(dom),written=!0;written&&view.trackWrites==parentDOM&&(view.trackWrites=null)}var OuterDecoLevel=function(nodeName){nodeName&&(this.nodeName=nodeName)};OuterDecoLevel.prototype=Object.create(null);var noDeco=[new OuterDecoLevel];function computeOuterDeco(outerDeco,node,needsWrap){if(outerDeco.length==0)return noDeco;for(var top=needsWrap?noDeco[0]:new OuterDecoLevel,result=[top],i=0;i<outerDeco.length;i++){var attrs=outerDeco[i].type.attrs;if(!!attrs){attrs.nodeName&&result.push(top=new OuterDecoLevel(attrs.nodeName));for(var name in attrs){var val=attrs[name];val!=null&&(needsWrap&&result.length==1&&result.push(top=new OuterDecoLevel(node.isInline?"span":"div")),name=="class"?top.class=(top.class?top.class+" ":"")+val:name=="style"?top.style=(top.style?top.style+";":"")+val:name!="nodeName"&&(top[name]=val))}}}return result}function patchOuterDeco(outerDOM,nodeDOM,prevComputed,curComputed){if(prevComputed==noDeco&&curComputed==noDeco)return nodeDOM;for(var curDOM=nodeDOM,i=0;i<curComputed.length;i++){var deco=curComputed[i],prev=prevComputed[i];if(i){var parent=void 0;prev&&prev.nodeName==deco.nodeName&&curDOM!=outerDOM&&(parent=curDOM.parentNode)&&parent.nodeName.toLowerCase()==deco.nodeName||(parent=document.createElement(deco.nodeName),parent.pmIsDeco=!0,parent.appendChild(curDOM),prev=noDeco[0]),curDOM=parent}patchAttributes(curDOM,prev||noDeco[0],deco)}return curDOM}function patchAttributes(dom,prev,cur){for(var name in prev)name!="class"&&name!="style"&&name!="nodeName"&&!(name in cur)&&dom.removeAttribute(name);for(var _name in cur)_name!="class"&&_name!="style"&&_name!="nodeName"&&cur[_name]!=prev[_name]&&dom.setAttribute(_name,cur[_name]);if(prev.class!=cur.class){for(var prevList=prev.class?prev.class.split(" ").filter(Boolean):[],curList=cur.class?cur.class.split(" ").filter(Boolean):[],i=0;i<prevList.length;i++)curList.indexOf(prevList[i])==-1&&dom.classList.remove(prevList[i]);for(var _i=0;_i<curList.length;_i++)prevList.indexOf(curList[_i])==-1&&dom.classList.add(curList[_i]);dom.classList.length==0&&dom.removeAttribute("class")}if(prev.style!=cur.style){if(prev.style)for(var prop2=/\s*([\w\-\xa1-\uffff]+)\s*:(?:"(?:\\.|[^"])*"|'(?:\\.|[^'])*'|\(.*?\)|[^;])*/g,m;m=prop2.exec(prev.style);)dom.style.removeProperty(m[1]);cur.style&&(dom.style.cssText+=cur.style)}}function applyOuterDeco(dom,deco,node){return patchOuterDeco(dom,dom,noDeco,computeOuterDeco(deco,node,dom.nodeType!=1))}function sameOuterDeco(a,b){if(a.length!=b.length)return!1;for(var i=0;i<a.length;i++)if(!a[i].type.eq(b[i].type))return!1;return!0}function rm(dom){var next=dom.nextSibling;return dom.parentNode.removeChild(dom),next}var ViewTreeUpdater=function(){function ViewTreeUpdater2(top,lock){_classCallCheck(this,ViewTreeUpdater2),this.lock=lock,this.index=0,this.stack=[],this.changed=!1,this.top=top,this.preMatch=preMatch(top.node.content,top)}return _createClass(ViewTreeUpdater2,[{key:"destroyBetween",value:function(start,end){if(start!=end){for(var i=start;i<end;i++)this.top.children[i].destroy();this.top.children.splice(start,end-start),this.changed=!0}}},{key:"destroyRest",value:function(){this.destroyBetween(this.index,this.top.children.length)}},{key:"syncToMarks",value:function(marks,inline,view){for(var keep=0,depth=this.stack.length>>1,maxKeep=Math.min(depth,marks.length);keep<maxKeep&&(keep==depth-1?this.top:this.stack[keep+1<<1]).matchesMark(marks[keep])&&marks[keep].type.spec.spanning!==!1;)keep++;for(;keep<depth;)this.destroyRest(),this.top.dirty=NOT_DIRTY,this.index=this.stack.pop(),this.top=this.stack.pop(),depth--;for(;depth<marks.length;){this.stack.push(this.top,this.index+1);for(var found=-1,i=this.index;i<Math.min(this.index+3,this.top.children.length);i++)if(this.top.children[i].matchesMark(marks[depth])){found=i;break}if(found>-1)found>this.index&&(this.changed=!0,this.destroyBetween(this.index,found)),this.top=this.top.children[this.index];else{var markDesc=MarkViewDesc.create(this.top,marks[depth],inline,view);this.top.children.splice(this.index,0,markDesc),this.top=markDesc,this.changed=!0}this.index=0,depth++}}},{key:"findNodeMatch",value:function(node,outerDeco,innerDeco,index){var found=-1,targetDesc;if(index>=this.preMatch.index&&(targetDesc=this.preMatch.matches[index-this.preMatch.index]).parent==this.top&&targetDesc.matchesNode(node,outerDeco,innerDeco))found=this.top.children.indexOf(targetDesc,this.index);else for(var i=this.index,e=Math.min(this.top.children.length,i+5);i<e;i++){var child=this.top.children[i];if(child.matchesNode(node,outerDeco,innerDeco)&&!this.preMatch.matched.has(child)){found=i;break}}return found<0?!1:(this.destroyBetween(this.index,found),this.index++,!0)}},{key:"updateNodeAt",value:function(node,outerDeco,innerDeco,index,view){var child=this.top.children[index];return child.dirty==NODE_DIRTY&&child.dom==child.contentDOM&&(child.dirty=CONTENT_DIRTY),child.update(node,outerDeco,innerDeco,view)?(this.destroyBetween(this.index,index),this.index=index+1,!0):!1}},{key:"findIndexWithChild",value:function(domNode){for(;;){var parent=domNode.parentNode;if(!parent)return-1;if(parent==this.top.contentDOM){var desc=domNode.pmViewDesc;if(desc){for(var i=this.index;i<this.top.children.length;i++)if(this.top.children[i]==desc)return i}return-1}domNode=parent}}},{key:"updateNextNode",value:function(node,outerDeco,innerDeco,view,index){for(var i=this.index;i<this.top.children.length;i++){var next=this.top.children[i];if(next instanceof NodeViewDesc){var _preMatch=this.preMatch.matched.get(next);if(_preMatch!=null&&_preMatch!=index)return!1;var nextDOM=next.dom,locked=this.lock&&(nextDOM==this.lock||nextDOM.nodeType==1&&nextDOM.contains(this.lock.parentNode))&&!(node.isText&&next.node&&next.node.isText&&next.nodeDOM.nodeValue==node.text&&next.dirty!=NODE_DIRTY&&sameOuterDeco(outerDeco,next.outerDeco));if(!locked&&next.update(node,outerDeco,innerDeco,view))return this.destroyBetween(this.index,i),next.dom!=nextDOM&&(this.changed=!0),this.index++,!0;break}}return!1}},{key:"addNode",value:function(node,outerDeco,innerDeco,view,pos){this.top.children.splice(this.index++,0,NodeViewDesc.create(this.top,node,outerDeco,innerDeco,view,pos)),this.changed=!0}},{key:"placeWidget",value:function(widget,view,pos){var next=this.index<this.top.children.length?this.top.children[this.index]:null;if(next&&next.matchesWidget(widget)&&(widget==next.widget||!next.widget.type.toDOM.parentNode))this.index++;else{var desc=new WidgetViewDesc(this.top,widget,view,pos);this.top.children.splice(this.index++,0,desc),this.changed=!0}}},{key:"addTextblockHacks",value:function(){for(var lastChild=this.top.children[this.index-1],parent=this.top;lastChild instanceof MarkViewDesc;)parent=lastChild,lastChild=parent.children[parent.children.length-1];(!lastChild||!(lastChild instanceof TextViewDesc)||/\n$/.test(lastChild.node.text))&&((safari||chrome)&&lastChild&&lastChild.dom.contentEditable=="false"&&this.addHackNode("IMG",parent),this.addHackNode("BR",this.top))}},{key:"addHackNode",value:function(nodeName,parent){if(parent==this.top&&this.index<parent.children.length&&parent.children[this.index].matchesHack(nodeName))this.index++;else{var dom=document.createElement(nodeName);nodeName=="IMG"&&(dom.className="ProseMirror-separator",dom.alt=""),nodeName=="BR"&&(dom.className="ProseMirror-trailingBreak");var hack=new TrailingHackViewDesc(this.top,[],dom,null);parent!=this.top?parent.children.push(hack):parent.children.splice(this.index++,0,hack),this.changed=!0}}}]),ViewTreeUpdater2}();function preMatch(frag,parentDesc){var curDesc=parentDesc,descI=curDesc.children.length,fI=frag.childCount,matched=new Map,matches=[];outer:for(;fI>0;){for(var desc=void 0;;)if(descI){var next=curDesc.children[descI-1];if(next instanceof MarkViewDesc)curDesc=next,descI=next.children.length;else{desc=next,descI--;break}}else{if(curDesc==parentDesc)break outer;descI=curDesc.parent.children.indexOf(curDesc),curDesc=curDesc.parent}var node=desc.node;if(!!node){if(node!=frag.child(fI-1))break;--fI,matched.set(desc,fI),matches.push(desc)}}return{index:fI,matched,matches:matches.reverse()}}function compareSide(a,b){return a.type.side-b.type.side}function iterDeco(parent,deco,onWidget,onNode){var locals=deco.locals(parent),offset=0;if(locals.length==0){for(var i=0;i<parent.childCount;i++){var child=parent.child(i);onNode(child,locals,deco.forChild(offset,child),i),offset+=child.nodeSize}return}for(var decoIndex=0,active=[],restNode=null,parentIndex=0;;){if(decoIndex<locals.length&&locals[decoIndex].to==offset){for(var widget=locals[decoIndex++],widgets=void 0;decoIndex<locals.length&&locals[decoIndex].to==offset;)(widgets||(widgets=[widget])).push(locals[decoIndex++]);if(widgets){widgets.sort(compareSide);for(var _i2=0;_i2<widgets.length;_i2++)onWidget(widgets[_i2],parentIndex,!!restNode)}else onWidget(widget,parentIndex,!!restNode)}var _child=void 0,index=void 0;if(restNode)index=-1,_child=restNode,restNode=null;else if(parentIndex<parent.childCount)index=parentIndex,_child=parent.child(parentIndex++);else break;for(var _i3=0;_i3<active.length;_i3++)active[_i3].to<=offset&&active.splice(_i3--,1);for(;decoIndex<locals.length&&locals[decoIndex].from<=offset&&locals[decoIndex].to>offset;)active.push(locals[decoIndex++]);var end=offset+_child.nodeSize;if(_child.isText){var cutAt=end;decoIndex<locals.length&&locals[decoIndex].from<cutAt&&(cutAt=locals[decoIndex].from);for(var _i4=0;_i4<active.length;_i4++)active[_i4].to<cutAt&&(cutAt=active[_i4].to);cutAt<end&&(restNode=_child.cut(cutAt-offset),_child=_child.cut(0,cutAt-offset),end=cutAt,index=-1)}var outerDeco=_child.isInline&&!_child.isLeaf?active.filter(function(d){return!d.inline}):active.slice();onNode(_child,outerDeco,deco.forChild(offset,_child),index),offset=end}}function iosHacks(dom){if(dom.nodeName=="UL"||dom.nodeName=="OL"){var oldCSS=dom.style.cssText;dom.style.cssText=oldCSS+"; list-style: square !important",window.getComputedStyle(dom).listStyle,dom.style.cssText=oldCSS}}function nearbyTextNode(node,offset){for(;;){if(node.nodeType==3)return node;if(node.nodeType==1&&offset>0){if(node.childNodes.length>offset&&node.childNodes[offset].nodeType==3)return node.childNodes[offset];node=node.childNodes[offset-1],offset=nodeSize(node)}else if(node.nodeType==1&&offset<node.childNodes.length)node=node.childNodes[offset],offset=0;else return null}}function findTextInFragment(frag,text,from,to){for(var i=0,pos=0;i<frag.childCount&&pos<=to;){var child=frag.child(i++),childStart=pos;if(pos+=child.nodeSize,!!child.isText){for(var str=child.text;i<frag.childCount;){var next=frag.child(i++);if(pos+=next.nodeSize,!next.isText)break;str+=next.text}if(pos>=from){var found=childStart<to?str.lastIndexOf(text,to-childStart-1):-1;if(found>=0&&found+text.length+childStart>=from)return childStart+found;if(from==to&&str.length>=to+text.length-childStart&&str.slice(to-childStart,to-childStart+text.length)==text)return to}}}return-1}function replaceNodes(nodes,from,to,view,replacement){for(var result=[],i=0,off=0;i<nodes.length;i++){var child=nodes[i],start=off,end=off+=child.size;start>=to||end<=from?result.push(child):(start<from&&result.push(child.slice(0,from-start,view)),replacement&&(result.push(replacement),replacement=void 0),end>to&&result.push(child.slice(to-start,child.size,view)))}return result}function selectionFromDOM(view){var origin=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null,domSel=view.domSelection(),doc2=view.state.doc;if(!domSel.focusNode)return null;var nearestDesc=view.docView.nearestDesc(domSel.focusNode),inWidget=nearestDesc&&nearestDesc.size==0,head=view.docView.posFromDOM(domSel.focusNode,domSel.focusOffset,1);if(head<0)return null;var $head=doc2.resolve(head),$anchor,selection;if(selectionCollapsed(domSel)){for($anchor=$head;nearestDesc&&!nearestDesc.node;)nearestDesc=nearestDesc.parent;var nearestDescNode=nearestDesc.node;if(nearestDesc&&nearestDescNode.isAtom&&prosemirrorState.NodeSelection.isSelectable(nearestDescNode)&&nearestDesc.parent&&!(nearestDescNode.isInline&&isOnEdge(domSel.focusNode,domSel.focusOffset,nearestDesc.dom))){var pos=nearestDesc.posBefore;selection=new prosemirrorState.NodeSelection(head==pos?$head:doc2.resolve(pos))}}else{var anchor=view.docView.posFromDOM(domSel.anchorNode,domSel.anchorOffset,1);if(anchor<0)return null;$anchor=doc2.resolve(anchor)}if(!selection){var bias=origin=="pointer"||view.state.selection.head<$head.pos&&!inWidget?1:-1;selection=selectionBetween(view,$anchor,$head,bias)}return selection}function editorOwnsSelection(view){return view.editable?view.hasFocus():hasSelection(view)&&document.activeElement&&document.activeElement.contains(view.dom)}function selectionToDOM(view){var force=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,sel=view.state.selection;if(syncNodeSelection(view,sel),!!editorOwnsSelection(view)){if(!force&&view.input.mouseDown&&view.input.mouseDown.allowDefault&&chrome){var domSel=view.domSelection(),curSel=view.domObserver.currentSelection;if(domSel.anchorNode&&curSel.anchorNode&&isEquivalentPosition(domSel.anchorNode,domSel.anchorOffset,curSel.anchorNode,curSel.anchorOffset)){view.input.mouseDown.delayedSelectionSync=!0,view.domObserver.setCurSelection();return}}if(view.domObserver.disconnectSelection(),view.cursorWrapper)selectCursorWrapper(view);else{var anchor=sel.anchor,head=sel.head,resetEditableFrom,resetEditableTo;brokenSelectBetweenUneditable&&!(sel instanceof prosemirrorState.TextSelection)&&(sel.$from.parent.inlineContent||(resetEditableFrom=temporarilyEditableNear(view,sel.from)),!sel.empty&&!sel.$from.parent.inlineContent&&(resetEditableTo=temporarilyEditableNear(view,sel.to))),view.docView.setSelection(anchor,head,view.root,force),brokenSelectBetweenUneditable&&(resetEditableFrom&&resetEditable(resetEditableFrom),resetEditableTo&&resetEditable(resetEditableTo)),sel.visible?view.dom.classList.remove("ProseMirror-hideselection"):(view.dom.classList.add("ProseMirror-hideselection"),"onselectionchange"in document&&removeClassOnSelectionChange(view))}view.domObserver.setCurSelection(),view.domObserver.connectSelection()}}var brokenSelectBetweenUneditable=safari||chrome&&chrome_version<63;function temporarilyEditableNear(view,pos){var _view$docView$domFrom3=view.docView.domFromPos(pos,0),node=_view$docView$domFrom3.node,offset=_view$docView$domFrom3.offset,after=offset<node.childNodes.length?node.childNodes[offset]:null,before=offset?node.childNodes[offset-1]:null;if(safari&&after&&after.contentEditable=="false")return setEditable(after);if((!after||after.contentEditable=="false")&&(!before||before.contentEditable=="false")){if(after)return setEditable(after);if(before)return setEditable(before)}}function setEditable(element){return element.contentEditable="true",safari&&element.draggable&&(element.draggable=!1,element.wasDraggable=!0),element}function resetEditable(element){element.contentEditable="false",element.wasDraggable&&(element.draggable=!0,element.wasDraggable=null)}function removeClassOnSelectionChange(view){var doc2=view.dom.ownerDocument;doc2.removeEventListener("selectionchange",view.input.hideSelectionGuard);var domSel=view.domSelection(),node=domSel.anchorNode,offset=domSel.anchorOffset;doc2.addEventListener("selectionchange",view.input.hideSelectionGuard=function(){(domSel.anchorNode!=node||domSel.anchorOffset!=offset)&&(doc2.removeEventListener("selectionchange",view.input.hideSelectionGuard),setTimeout(function(){(!editorOwnsSelection(view)||view.state.selection.visible)&&view.dom.classList.remove("ProseMirror-hideselection")},20))})}function selectCursorWrapper(view){var domSel=view.domSelection(),range=document.createRange(),node=view.cursorWrapper.dom,img=node.nodeName=="IMG";img?range.setEnd(node.parentNode,domIndex(node)+1):range.setEnd(node,0),range.collapse(!1),domSel.removeAllRanges(),domSel.addRange(range),!img&&!view.state.selection.visible&&ie&&ie_version<=11&&(node.disabled=!0,node.disabled=!1)}function syncNodeSelection(view,sel){if(sel instanceof prosemirrorState.NodeSelection){var desc=view.docView.descAt(sel.from);desc!=view.lastSelectedViewDesc&&(clearNodeSelection(view),desc&&desc.selectNode(),view.lastSelectedViewDesc=desc)}else clearNodeSelection(view)}function clearNodeSelection(view){view.lastSelectedViewDesc&&(view.lastSelectedViewDesc.parent&&view.lastSelectedViewDesc.deselectNode(),view.lastSelectedViewDesc=void 0)}function selectionBetween(view,$anchor,$head,bias){return view.someProp("createSelectionBetween",function(f){return f(view,$anchor,$head)})||prosemirrorState.TextSelection.between($anchor,$head,bias)}function hasFocusAndSelection(view){return view.editable&&view.root.activeElement!=view.dom?!1:hasSelection(view)}function hasSelection(view){var sel=view.domSelection();if(!sel.anchorNode)return!1;try{return view.dom.contains(sel.anchorNode.nodeType==3?sel.anchorNode.parentNode:sel.anchorNode)&&(view.editable||view.dom.contains(sel.focusNode.nodeType==3?sel.focusNode.parentNode:sel.focusNode))}catch(_){return!1}}function anchorInRightPlace(view){var anchorDOM=view.docView.domFromPos(view.state.selection.anchor,0),domSel=view.domSelection();return isEquivalentPosition(anchorDOM.node,anchorDOM.offset,domSel.anchorNode,domSel.anchorOffset)}function moveSelectionBlock(state,dir){var _state$selection=state.selection,$anchor=_state$selection.$anchor,$head=_state$selection.$head,$side=dir>0?$anchor.max($head):$anchor.min($head),$start=$side.parent.inlineContent?$side.depth?state.doc.resolve(dir>0?$side.after():$side.before()):null:$side;return $start&&prosemirrorState.Selection.findFrom($start,dir)}function apply(view,sel){return view.dispatch(view.state.tr.setSelection(sel).scrollIntoView()),!0}function selectHorizontally(view,dir,mods){var sel=view.state.selection;if(sel instanceof prosemirrorState.TextSelection){if(!sel.empty||mods.indexOf("s")>-1)return!1;if(view.endOfTextblock(dir>0?"right":"left")){var next=moveSelectionBlock(view.state,dir);return next&&next instanceof prosemirrorState.NodeSelection?apply(view,next):!1}else if(!(mac&&mods.indexOf("m")>-1)){var $head=sel.$head,node=$head.textOffset?null:dir<0?$head.nodeBefore:$head.nodeAfter,desc;if(!node||node.isText)return!1;var nodePos=dir<0?$head.pos-node.nodeSize:$head.pos;return node.isAtom||(desc=view.docView.descAt(nodePos))&&!desc.contentDOM?prosemirrorState.NodeSelection.isSelectable(node)?apply(view,new prosemirrorState.NodeSelection(dir<0?view.state.doc.resolve($head.pos-node.nodeSize):$head)):webkit?apply(view,new prosemirrorState.TextSelection(view.state.doc.resolve(dir<0?nodePos:nodePos+node.nodeSize))):!1:!1}}else{if(sel instanceof prosemirrorState.NodeSelection&&sel.node.isInline)return apply(view,new prosemirrorState.TextSelection(dir>0?sel.$to:sel.$from));var _next=moveSelectionBlock(view.state,dir);return _next?apply(view,_next):!1}}function nodeLen(node){return node.nodeType==3?node.nodeValue.length:node.childNodes.length}function isIgnorable(dom){var desc=dom.pmViewDesc;return desc&&desc.size==0&&(dom.nextSibling||dom.nodeName!="BR")}function skipIgnoredNodesLeft(view){var sel=view.domSelection(),node=sel.focusNode,offset=sel.focusOffset;if(!!node){var moveNode,moveOffset,force=!1;for(gecko&&node.nodeType==1&&offset<nodeLen(node)&&isIgnorable(node.childNodes[offset])&&(force=!0);;)if(offset>0){if(node.nodeType!=1)break;var before=node.childNodes[offset-1];if(isIgnorable(before))moveNode=node,moveOffset=--offset;else if(before.nodeType==3)node=before,offset=node.nodeValue.length;else break}else{if(isBlockNode(node))break;for(var prev=node.previousSibling;prev&&isIgnorable(prev);)moveNode=node.parentNode,moveOffset=domIndex(prev),prev=prev.previousSibling;if(prev)node=prev,offset=nodeLen(node);else{if(node=node.parentNode,node==view.dom)break;offset=0}}force?setSelFocus(view,sel,node,offset):moveNode&&setSelFocus(view,sel,moveNode,moveOffset)}}function skipIgnoredNodesRight(view){var sel=view.domSelection(),node=sel.focusNode,offset=sel.focusOffset;if(!!node){for(var len=nodeLen(node),moveNode,moveOffset;;)if(offset<len){if(node.nodeType!=1)break;var after=node.childNodes[offset];if(isIgnorable(after))moveNode=node,moveOffset=++offset;else break}else{if(isBlockNode(node))break;for(var next=node.nextSibling;next&&isIgnorable(next);)moveNode=next.parentNode,moveOffset=domIndex(next)+1,next=next.nextSibling;if(next)node=next,offset=0,len=nodeLen(node);else{if(node=node.parentNode,node==view.dom)break;offset=len=0}}moveNode&&setSelFocus(view,sel,moveNode,moveOffset)}}function isBlockNode(dom){var desc=dom.pmViewDesc;return desc&&desc.node&&desc.node.isBlock}function setSelFocus(view,sel,node,offset){if(selectionCollapsed(sel)){var range=document.createRange();range.setEnd(node,offset),range.setStart(node,offset),sel.removeAllRanges(),sel.addRange(range)}else sel.extend&&sel.extend(node,offset);view.domObserver.setCurSelection();var state=view.state;setTimeout(function(){view.state==state&&selectionToDOM(view)},50)}function selectVertically(view,dir,mods){var sel=view.state.selection;if(sel instanceof prosemirrorState.TextSelection&&!sel.empty||mods.indexOf("s")>-1||mac&&mods.indexOf("m")>-1)return!1;var $from=sel.$from,$to=sel.$to;if(!$from.parent.inlineContent||view.endOfTextblock(dir<0?"up":"down")){var next=moveSelectionBlock(view.state,dir);if(next&&next instanceof prosemirrorState.NodeSelection)return apply(view,next)}if(!$from.parent.inlineContent){var side=dir<0?$from:$to,beyond=sel instanceof prosemirrorState.AllSelection?prosemirrorState.Selection.near(side,dir):prosemirrorState.Selection.findFrom(side,dir);return beyond?apply(view,beyond):!1}return!1}function stopNativeHorizontalDelete(view,dir){if(!(view.state.selection instanceof prosemirrorState.TextSelection))return!0;var _view$state$selection2=view.state.selection,$head=_view$state$selection2.$head,$anchor=_view$state$selection2.$anchor,empty2=_view$state$selection2.empty;if(!$head.sameParent($anchor))return!0;if(!empty2)return!1;if(view.endOfTextblock(dir>0?"forward":"backward"))return!0;var nextNode=!$head.textOffset&&(dir<0?$head.nodeBefore:$head.nodeAfter);if(nextNode&&!nextNode.isText){var tr=view.state.tr;return dir<0?tr.delete($head.pos-nextNode.nodeSize,$head.pos):tr.delete($head.pos,$head.pos+nextNode.nodeSize),view.dispatch(tr),!0}return!1}function switchEditable(view,node,state){view.domObserver.stop(),node.contentEditable=state,view.domObserver.start()}function safariDownArrowBug(view){if(!safari||view.state.selection.$head.parentOffset>0)return!1;var _view$domSelection=view.domSelection(),focusNode=_view$domSelection.focusNode,focusOffset=_view$domSelection.focusOffset;if(focusNode&&focusNode.nodeType==1&&focusOffset==0&&focusNode.firstChild&&focusNode.firstChild.contentEditable=="false"){var child=focusNode.firstChild;switchEditable(view,child,"true"),setTimeout(function(){return switchEditable(view,child,"false")},20)}return!1}function getMods(event){var result="";return event.ctrlKey&&(result+="c"),event.metaKey&&(result+="m"),event.altKey&&(result+="a"),event.shiftKey&&(result+="s"),result}function captureKeyDown(view,event){var code=event.keyCode,mods=getMods(event);return code==8||mac&&code==72&&mods=="c"?stopNativeHorizontalDelete(view,-1)||skipIgnoredNodesLeft(view):code==46||mac&&code==68&&mods=="c"?stopNativeHorizontalDelete(view,1)||skipIgnoredNodesRight(view):code==13||code==27?!0:code==37||mac&&code==66&&mods=="c"?selectHorizontally(view,-1,mods)||skipIgnoredNodesLeft(view):code==39||mac&&code==70&&mods=="c"?selectHorizontally(view,1,mods)||skipIgnoredNodesRight(view):code==38||mac&&code==80&&mods=="c"?selectVertically(view,-1,mods)||skipIgnoredNodesLeft(view):code==40||mac&&code==78&&mods=="c"?safariDownArrowBug(view)||selectVertically(view,1,mods)||skipIgnoredNodesRight(view):mods==(mac?"m":"c")&&(code==66||code==73||code==89||code==90)}function serializeForClipboard(view,slice){for(var context=[],content=slice.content,openStart=slice.openStart,openEnd=slice.openEnd;openStart>1&&openEnd>1&&content.childCount==1&&content.firstChild.childCount==1;){openStart--,openEnd--;var node=content.firstChild;context.push(node.type.name,node.attrs!=node.type.defaultAttrs?node.attrs:null),content=node.content}var serializer=view.someProp("clipboardSerializer")||prosemirrorModel.DOMSerializer.fromSchema(view.state.schema),doc2=detachedDoc(),wrap=doc2.createElement("div");wrap.appendChild(serializer.serializeFragment(content,{document:doc2}));for(var firstChild=wrap.firstChild,needsWrap,wrappers=0;firstChild&&firstChild.nodeType==1&&(needsWrap=wrapMap[firstChild.nodeName.toLowerCase()]);){for(var i=needsWrap.length-1;i>=0;i--){for(var wrapper=doc2.createElement(needsWrap[i]);wrap.firstChild;)wrapper.appendChild(wrap.firstChild);wrap.appendChild(wrapper),wrappers++}firstChild=wrap.firstChild}firstChild&&firstChild.nodeType==1&&firstChild.setAttribute("data-pm-slice","".concat(openStart," ").concat(openEnd).concat(wrappers?" -".concat(wrappers):""," ").concat(JSON.stringify(context)));var text=view.someProp("clipboardTextSerializer",function(f){return f(slice)})||slice.content.textBetween(0,slice.content.size,`

`);return{dom:wrap,text}}function parseFromClipboard(view,text,html,plainText,$context){var inCode=$context.parent.type.spec.code,dom,slice;if(!html&&!text)return null;var asText=text&&(plainText||inCode||!html);if(asText){if(view.someProp("transformPastedText",function(f){text=f(text,inCode||plainText)}),inCode)return text?new prosemirrorModel.Slice(prosemirrorModel.Fragment.from(view.state.schema.text(text.replace(/\r\n?/g,`
`))),0,0):prosemirrorModel.Slice.empty;var parsed=view.someProp("clipboardTextParser",function(f){return f(text,$context,plainText)});if(parsed)slice=parsed;else{var marks=$context.marks(),schema=view.state.schema,serializer=prosemirrorModel.DOMSerializer.fromSchema(schema);dom=document.createElement("div"),text.split(/(?:\r\n?|\n)+/).forEach(function(block){var p=dom.appendChild(document.createElement("p"));block&&p.appendChild(serializer.serializeNode(schema.text(block,marks)))})}}else view.someProp("transformPastedHTML",function(f){html=f(html)}),dom=readHTML(html),webkit&&restoreReplacedSpaces(dom);var contextNode=dom&&dom.querySelector("[data-pm-slice]"),sliceData=contextNode&&/^(\d+) (\d+)(?: -(\d+))? (.*)/.exec(contextNode.getAttribute("data-pm-slice")||"");if(sliceData&&sliceData[3])for(var i=+sliceData[3];i>0&&dom.firstChild;i--)dom=dom.firstChild;if(!slice){var parser=view.someProp("clipboardParser")||view.someProp("domParser")||prosemirrorModel.DOMParser.fromSchema(view.state.schema);slice=parser.parseSlice(dom,{preserveWhitespace:!!(asText||sliceData),context:$context,ruleFromNode:function(dom2){return dom2.nodeName=="BR"&&!dom2.nextSibling&&dom2.parentNode&&!inlineParents.test(dom2.parentNode.nodeName)?{ignore:!0}:null}})}if(sliceData)slice=addContext(closeSlice(slice,+sliceData[1],+sliceData[2]),sliceData[4]);else if(slice=prosemirrorModel.Slice.maxOpen(normalizeSiblings(slice.content,$context),!0),slice.openStart||slice.openEnd){for(var openStart=0,openEnd=0,node=slice.content.firstChild;openStart<slice.openStart&&!node.type.spec.isolating;openStart++,node=node.firstChild);for(var _node=slice.content.lastChild;openEnd<slice.openEnd&&!_node.type.spec.isolating;openEnd++,_node=_node.lastChild);slice=closeSlice(slice,openStart,openEnd)}return view.someProp("transformPasted",function(f){slice=f(slice)}),slice}var inlineParents=/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var)$/i;function normalizeSiblings(fragment,$context){if(fragment.childCount<2)return fragment;for(var _loop=function(d2){var parent=$context.node(d2),match=parent.contentMatchAt($context.index(d2)),lastWrap=void 0,result=[];if(fragment.forEach(function(node){if(!!result){var wrap=match.findWrapping(node.type),inLast;if(!wrap)return result=null;if(inLast=result.length&&lastWrap.length&&addToSibling(wrap,lastWrap,node,result[result.length-1],0))result[result.length-1]=inLast;else{result.length&&(result[result.length-1]=closeRight(result[result.length-1],lastWrap.length));var wrapped=withWrappers(node,wrap);result.push(wrapped),match=match.matchType(wrapped.type),lastWrap=wrap}}}),result)return{v:prosemirrorModel.Fragment.from(result)}},d=$context.depth;d>=0;d--){var _ret=_loop(d);if(_typeof(_ret)==="object")return _ret.v}return fragment}function withWrappers(node,wrap){for(var from=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,i=wrap.length-1;i>=from;i--)node=wrap[i].create(null,prosemirrorModel.Fragment.from(node));return node}function addToSibling(wrap,lastWrap,node,sibling,depth){if(depth<wrap.length&&depth<lastWrap.length&&wrap[depth]==lastWrap[depth]){var inner=addToSibling(wrap,lastWrap,node,sibling.lastChild,depth+1);if(inner)return sibling.copy(sibling.content.replaceChild(sibling.childCount-1,inner));var match=sibling.contentMatchAt(sibling.childCount);if(match.matchType(depth==wrap.length-1?node.type:wrap[depth+1]))return sibling.copy(sibling.content.append(prosemirrorModel.Fragment.from(withWrappers(node,wrap,depth+1))))}}function closeRight(node,depth){if(depth==0)return node;var fragment=node.content.replaceChild(node.childCount-1,closeRight(node.lastChild,depth-1)),fill=node.contentMatchAt(node.childCount).fillBefore(prosemirrorModel.Fragment.empty,!0);return node.copy(fragment.append(fill))}function closeRange(fragment,side,from,to,depth,openEnd){var node=side<0?fragment.firstChild:fragment.lastChild,inner=node.content;return depth<to-1&&(inner=closeRange(inner,side,from,to,depth+1,openEnd)),depth>=from&&(inner=side<0?node.contentMatchAt(0).fillBefore(inner,fragment.childCount>1||openEnd<=depth).append(inner):inner.append(node.contentMatchAt(node.childCount).fillBefore(prosemirrorModel.Fragment.empty,!0))),fragment.replaceChild(side<0?0:fragment.childCount-1,node.copy(inner))}function closeSlice(slice,openStart,openEnd){return openStart<slice.openStart&&(slice=new prosemirrorModel.Slice(closeRange(slice.content,-1,openStart,slice.openStart,0,slice.openEnd),openStart,slice.openEnd)),openEnd<slice.openEnd&&(slice=new prosemirrorModel.Slice(closeRange(slice.content,1,openEnd,slice.openEnd,0,0),slice.openStart,openEnd)),slice}var wrapMap={thead:["table"],tbody:["table"],tfoot:["table"],caption:["table"],colgroup:["table"],col:["table","colgroup"],tr:["table","tbody"],td:["table","tbody","tr"],th:["table","tbody","tr"]},_detachedDoc=null;function detachedDoc(){return _detachedDoc||(_detachedDoc=document.implementation.createHTMLDocument("title"))}function readHTML(html){var metas=/^(\s*<meta [^>]*>)*/.exec(html);metas&&(html=html.slice(metas[0].length));var elt=detachedDoc().createElement("div"),firstTag=/<([a-z][^>\s]+)/i.exec(html),wrap;if((wrap=firstTag&&wrapMap[firstTag[1].toLowerCase()])&&(html=wrap.map(function(n){return"<"+n+">"}).join("")+html+wrap.map(function(n){return"</"+n+">"}).reverse().join("")),elt.innerHTML=html,wrap)for(var i=0;i<wrap.length;i++)elt=elt.querySelector(wrap[i])||elt;return elt}function restoreReplacedSpaces(dom){for(var nodes=dom.querySelectorAll(chrome?"span:not([class]):not([style])":"span.Apple-converted-space"),i=0;i<nodes.length;i++){var node=nodes[i];node.childNodes.length==1&&node.textContent=="\xA0"&&node.parentNode&&node.parentNode.replaceChild(dom.ownerDocument.createTextNode(" "),node)}}function addContext(slice,context){if(!slice.size)return slice;var schema=slice.content.firstChild.type.schema,array;try{array=JSON.parse(context)}catch(e){return slice}for(var content=slice.content,openStart=slice.openStart,openEnd=slice.openEnd,i=array.length-2;i>=0;i-=2){var type=schema.nodes[array[i]];if(!type||type.hasRequiredAttrs())break;content=prosemirrorModel.Fragment.from(type.create(array[i+1],content)),openStart++,openEnd++}return new prosemirrorModel.Slice(content,openStart,openEnd)}var handlers={},editHandlers={},InputState=_createClass(function InputState2(){_classCallCheck(this,InputState2),this.shiftKey=!1,this.mouseDown=null,this.lastKeyCode=null,this.lastKeyCodeTime=0,this.lastClick={time:0,x:0,y:0,type:""},this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastIOSEnter=0,this.lastIOSEnterFallbackTimeout=-1,this.lastAndroidDelete=0,this.composing=!1,this.composingTimeout=-1,this.compositionNodes=[],this.compositionEndedAt=-2e8,this.domChangeCount=0,this.eventHandlers=Object.create(null),this.hideSelectionGuard=null});function initInput(view){var _loop2=function(event2){var handler=handlers[event2];view.dom.addEventListener(event2,view.input.eventHandlers[event2]=function(event3){eventBelongsToView(view,event3)&&!runCustomHandler(view,event3)&&(view.editable||!(event3.type in editHandlers))&&handler(view,event3)})};for(var event in handlers)_loop2(event);safari&&view.dom.addEventListener("input",function(){return null}),ensureListeners(view)}function setSelectionOrigin(view,origin){view.input.lastSelectionOrigin=origin,view.input.lastSelectionTime=Date.now()}function destroyInput(view){view.domObserver.stop();for(var type in view.input.eventHandlers)view.dom.removeEventListener(type,view.input.eventHandlers[type]);clearTimeout(view.input.composingTimeout),clearTimeout(view.input.lastIOSEnterFallbackTimeout)}function ensureListeners(view){view.someProp("handleDOMEvents",function(currentHandlers){for(var type in currentHandlers)view.input.eventHandlers[type]||view.dom.addEventListener(type,view.input.eventHandlers[type]=function(event){return runCustomHandler(view,event)})})}function runCustomHandler(view,event){return view.someProp("handleDOMEvents",function(handlers2){var handler=handlers2[event.type];return handler?handler(view,event)||event.defaultPrevented:!1})}function eventBelongsToView(view,event){if(!event.bubbles)return!0;if(event.defaultPrevented)return!1;for(var node=event.target;node!=view.dom;node=node.parentNode)if(!node||node.nodeType==11||node.pmViewDesc&&node.pmViewDesc.stopEvent(event))return!1;return!0}function _dispatchEvent(view,event){!runCustomHandler(view,event)&&handlers[event.type]&&(view.editable||!(event.type in editHandlers))&&handlers[event.type](view,event)}editHandlers.keydown=function(view,_event){var event=_event;if(view.input.shiftKey=event.keyCode==16||event.shiftKey,!inOrNearComposition(view,event)&&(view.input.lastKeyCode=event.keyCode,view.input.lastKeyCodeTime=Date.now(),!(android&&chrome&&event.keyCode==13)))if(event.keyCode!=229&&view.domObserver.forceFlush(),ios&&event.keyCode==13&&!event.ctrlKey&&!event.altKey&&!event.metaKey){var now=Date.now();view.input.lastIOSEnter=now,view.input.lastIOSEnterFallbackTimeout=setTimeout(function(){view.input.lastIOSEnter==now&&(view.someProp("handleKeyDown",function(f){return f(view,keyEvent(13,"Enter"))}),view.input.lastIOSEnter=0)},200)}else view.someProp("handleKeyDown",function(f){return f(view,event)})||captureKeyDown(view,event)?event.preventDefault():setSelectionOrigin(view,"key")},editHandlers.keyup=function(view,event){event.keyCode==16&&(view.input.shiftKey=!1)},editHandlers.keypress=function(view,_event){var event=_event;if(!(inOrNearComposition(view,event)||!event.charCode||event.ctrlKey&&!event.altKey||mac&&event.metaKey)){if(view.someProp("handleKeyPress",function(f){return f(view,event)})){event.preventDefault();return}var sel=view.state.selection;if(!(sel instanceof prosemirrorState.TextSelection)||!sel.$from.sameParent(sel.$to)){var text=String.fromCharCode(event.charCode);view.someProp("handleTextInput",function(f){return f(view,sel.$from.pos,sel.$to.pos,text)})||view.dispatch(view.state.tr.insertText(text).scrollIntoView()),event.preventDefault()}}};function eventCoords(event){return{left:event.clientX,top:event.clientY}}function isNear(event,click){var dx=click.x-event.clientX,dy=click.y-event.clientY;return dx*dx+dy*dy<100}function runHandlerOnContext(view,propName,pos,inside,event){if(inside==-1)return!1;for(var $pos=view.state.doc.resolve(inside),_loop3=function(i2){if(view.someProp(propName,function(f){return i2>$pos.depth?f(view,pos,$pos.nodeAfter,$pos.before(i2),event,!0):f(view,pos,$pos.node(i2),$pos.before(i2),event,!1)}))return{v:!0}},i=$pos.depth+1;i>0;i--){var _ret2=_loop3(i);if(_typeof(_ret2)==="object")return _ret2.v}return!1}function updateSelection(view,selection,origin){view.focused||view.focus();var tr=view.state.tr.setSelection(selection);origin=="pointer"&&tr.setMeta("pointer",!0),view.dispatch(tr)}function selectClickedLeaf(view,inside){if(inside==-1)return!1;var $pos=view.state.doc.resolve(inside),node=$pos.nodeAfter;return node&&node.isAtom&&prosemirrorState.NodeSelection.isSelectable(node)?(updateSelection(view,new prosemirrorState.NodeSelection($pos),"pointer"),!0):!1}function selectClickedNode(view,inside){if(inside==-1)return!1;var sel=view.state.selection,selectedNode,selectAt;sel instanceof prosemirrorState.NodeSelection&&(selectedNode=sel.node);for(var $pos=view.state.doc.resolve(inside),i=$pos.depth+1;i>0;i--){var node=i>$pos.depth?$pos.nodeAfter:$pos.node(i);if(prosemirrorState.NodeSelection.isSelectable(node)){selectedNode&&sel.$from.depth>0&&i>=sel.$from.depth&&$pos.before(sel.$from.depth+1)==sel.$from.pos?selectAt=$pos.before(sel.$from.depth):selectAt=$pos.before(i);break}}return selectAt!=null?(updateSelection(view,prosemirrorState.NodeSelection.create(view.state.doc,selectAt),"pointer"),!0):!1}function handleSingleClick(view,pos,inside,event,selectNode){return runHandlerOnContext(view,"handleClickOn",pos,inside,event)||view.someProp("handleClick",function(f){return f(view,pos,event)})||(selectNode?selectClickedNode(view,inside):selectClickedLeaf(view,inside))}function handleDoubleClick(view,pos,inside,event){return runHandlerOnContext(view,"handleDoubleClickOn",pos,inside,event)||view.someProp("handleDoubleClick",function(f){return f(view,pos,event)})}function handleTripleClick(view,pos,inside,event){return runHandlerOnContext(view,"handleTripleClickOn",pos,inside,event)||view.someProp("handleTripleClick",function(f){return f(view,pos,event)})||defaultTripleClick(view,inside,event)}function defaultTripleClick(view,inside,event){if(event.button!=0)return!1;var doc2=view.state.doc;if(inside==-1)return doc2.inlineContent?(updateSelection(view,prosemirrorState.TextSelection.create(doc2,0,doc2.content.size),"pointer"),!0):!1;for(var $pos=doc2.resolve(inside),i=$pos.depth+1;i>0;i--){var node=i>$pos.depth?$pos.nodeAfter:$pos.node(i),nodePos=$pos.before(i);if(node.inlineContent)updateSelection(view,prosemirrorState.TextSelection.create(doc2,nodePos+1,nodePos+1+node.content.size),"pointer");else if(prosemirrorState.NodeSelection.isSelectable(node))updateSelection(view,prosemirrorState.NodeSelection.create(doc2,nodePos),"pointer");else continue;return!0}}function forceDOMFlush(view){return endComposition(view)}var selectNodeModifier=mac?"metaKey":"ctrlKey";handlers.mousedown=function(view,_event){var event=_event;view.input.shiftKey=event.shiftKey;var flushed=forceDOMFlush(view),now=Date.now(),type="singleClick";now-view.input.lastClick.time<500&&isNear(event,view.input.lastClick)&&!event[selectNodeModifier]&&(view.input.lastClick.type=="singleClick"?type="doubleClick":view.input.lastClick.type=="doubleClick"&&(type="tripleClick")),view.input.lastClick={time:now,x:event.clientX,y:event.clientY,type};var pos=view.posAtCoords(eventCoords(event));!pos||(type=="singleClick"?(view.input.mouseDown&&view.input.mouseDown.done(),view.input.mouseDown=new MouseDown(view,pos,event,!!flushed)):(type=="doubleClick"?handleDoubleClick:handleTripleClick)(view,pos.pos,pos.inside,event)?event.preventDefault():setSelectionOrigin(view,"pointer"))};var MouseDown=function(){function MouseDown2(view,pos,event,flushed){var _this8=this;_classCallCheck(this,MouseDown2),this.view=view,this.pos=pos,this.event=event,this.flushed=flushed,this.delayedSelectionSync=!1,this.mightDrag=null,this.startDoc=view.state.doc,this.selectNode=!!event[selectNodeModifier],this.allowDefault=event.shiftKey;var targetNode,targetPos;if(pos.inside>-1)targetNode=view.state.doc.nodeAt(pos.inside),targetPos=pos.inside;else{var $pos=view.state.doc.resolve(pos.pos);targetNode=$pos.parent,targetPos=$pos.depth?$pos.before():0}var target=flushed?null:event.target,targetDesc=target?view.docView.nearestDesc(target,!0):null;this.target=targetDesc?targetDesc.dom:null;var selection=view.state.selection;(event.button==0&&targetNode.type.spec.draggable&&targetNode.type.spec.selectable!==!1||selection instanceof prosemirrorState.NodeSelection&&selection.from<=targetPos&&selection.to>targetPos)&&(this.mightDrag={node:targetNode,pos:targetPos,addAttr:!!(this.target&&!this.target.draggable),setUneditable:!!(this.target&&gecko&&!this.target.hasAttribute("contentEditable"))}),this.target&&this.mightDrag&&(this.mightDrag.addAttr||this.mightDrag.setUneditable)&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&(this.target.draggable=!0),this.mightDrag.setUneditable&&setTimeout(function(){_this8.view.input.mouseDown==_this8&&_this8.target.setAttribute("contentEditable","false")},20),this.view.domObserver.start()),view.root.addEventListener("mouseup",this.up=this.up.bind(this)),view.root.addEventListener("mousemove",this.move=this.move.bind(this)),setSelectionOrigin(view,"pointer")}return _createClass(MouseDown2,[{key:"done",value:function(){var _this9=this;this.view.root.removeEventListener("mouseup",this.up),this.view.root.removeEventListener("mousemove",this.move),this.mightDrag&&this.target&&(this.view.domObserver.stop(),this.mightDrag.addAttr&&this.target.removeAttribute("draggable"),this.mightDrag.setUneditable&&this.target.removeAttribute("contentEditable"),this.view.domObserver.start()),this.delayedSelectionSync&&setTimeout(function(){return selectionToDOM(_this9.view)}),this.view.input.mouseDown=null}},{key:"up",value:function(event){if(this.done(),!!this.view.dom.contains(event.target)){var pos=this.pos;this.view.state.doc!=this.startDoc&&(pos=this.view.posAtCoords(eventCoords(event))),this.allowDefault||!pos?setSelectionOrigin(this.view,"pointer"):handleSingleClick(this.view,pos.pos,pos.inside,event,this.selectNode)?event.preventDefault():event.button==0&&(this.flushed||safari&&this.mightDrag&&!this.mightDrag.node.isAtom||chrome&&!(this.view.state.selection instanceof prosemirrorState.TextSelection)&&Math.min(Math.abs(pos.pos-this.view.state.selection.from),Math.abs(pos.pos-this.view.state.selection.to))<=2)?(updateSelection(this.view,prosemirrorState.Selection.near(this.view.state.doc.resolve(pos.pos)),"pointer"),event.preventDefault()):setSelectionOrigin(this.view,"pointer")}}},{key:"move",value:function(event){!this.allowDefault&&(Math.abs(this.event.x-event.clientX)>4||Math.abs(this.event.y-event.clientY)>4)&&(this.allowDefault=!0),setSelectionOrigin(this.view,"pointer"),event.buttons==0&&this.done()}}]),MouseDown2}();handlers.touchdown=function(view){forceDOMFlush(view),setSelectionOrigin(view,"pointer")},handlers.contextmenu=function(view){return forceDOMFlush(view)};function inOrNearComposition(view,event){return view.composing?!0:safari&&Math.abs(event.timeStamp-view.input.compositionEndedAt)<500?(view.input.compositionEndedAt=-2e8,!0):!1}var timeoutComposition=android?5e3:-1;editHandlers.compositionstart=editHandlers.compositionupdate=function(view){if(!view.composing){view.domObserver.flush();var state=view.state,$pos=state.selection.$from;if(state.selection.empty&&(state.storedMarks||!$pos.textOffset&&$pos.parentOffset&&$pos.nodeBefore.marks.some(function(m){return m.type.spec.inclusive===!1})))view.markCursor=view.state.storedMarks||$pos.marks(),endComposition(view,!0),view.markCursor=null;else if(endComposition(view),gecko&&state.selection.empty&&$pos.parentOffset&&!$pos.textOffset&&$pos.nodeBefore.marks.length)for(var sel=view.domSelection(),node=sel.focusNode,offset=sel.focusOffset;node&&node.nodeType==1&&offset!=0;){var before=offset<0?node.lastChild:node.childNodes[offset-1];if(!before)break;if(before.nodeType==3){sel.collapse(before,before.nodeValue.length);break}else node=before,offset=-1}view.input.composing=!0}scheduleComposeEnd(view,timeoutComposition)},editHandlers.compositionend=function(view,event){view.composing&&(view.input.composing=!1,view.input.compositionEndedAt=event.timeStamp,scheduleComposeEnd(view,20))};function scheduleComposeEnd(view,delay){clearTimeout(view.input.composingTimeout),delay>-1&&(view.input.composingTimeout=setTimeout(function(){return endComposition(view)},delay))}function clearComposition(view){for(view.composing&&(view.input.composing=!1,view.input.compositionEndedAt=timestampFromCustomEvent());view.input.compositionNodes.length>0;)view.input.compositionNodes.pop().markParentsDirty()}function timestampFromCustomEvent(){var event=document.createEvent("Event");return event.initEvent("event",!0,!0),event.timeStamp}function endComposition(view){var forceUpdate=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!(android&&view.domObserver.flushingSoon>=0)){if(view.domObserver.forceFlush(),clearComposition(view),forceUpdate||view.docView&&view.docView.dirty){var sel=selectionFromDOM(view);return sel&&!sel.eq(view.state.selection)?view.dispatch(view.state.tr.setSelection(sel)):view.updateState(view.state),!0}return!1}}function captureCopy(view,dom){if(!!view.dom.parentNode){var wrap=view.dom.parentNode.appendChild(document.createElement("div"));wrap.appendChild(dom),wrap.style.cssText="position: fixed; left: -10000px; top: 10px";var sel=getSelection(),range=document.createRange();range.selectNodeContents(dom),view.dom.blur(),sel.removeAllRanges(),sel.addRange(range),setTimeout(function(){wrap.parentNode&&wrap.parentNode.removeChild(wrap),view.focus()},50)}}var brokenClipboardAPI=ie&&ie_version<15||ios&&webkit_version<604;handlers.copy=editHandlers.cut=function(view,_event){var event=_event,sel=view.state.selection,cut=event.type=="cut";if(!sel.empty){var data=brokenClipboardAPI?null:event.clipboardData,slice=sel.content(),_serializeForClipboar=serializeForClipboard(view,slice),dom=_serializeForClipboar.dom,text=_serializeForClipboar.text;data?(event.preventDefault(),data.clearData(),data.setData("text/html",dom.innerHTML),data.setData("text/plain",text)):captureCopy(view,dom),cut&&view.dispatch(view.state.tr.deleteSelection().scrollIntoView().setMeta("uiEvent","cut"))}};function sliceSingleNode(slice){return slice.openStart==0&&slice.openEnd==0&&slice.content.childCount==1?slice.content.firstChild:null}function capturePaste(view,event){if(!!view.dom.parentNode){var plainText=view.input.shiftKey||view.state.selection.$from.parent.type.spec.code,target=view.dom.parentNode.appendChild(document.createElement(plainText?"textarea":"div"));plainText||(target.contentEditable="true"),target.style.cssText="position: fixed; left: -10000px; top: 10px",target.focus(),setTimeout(function(){view.focus(),target.parentNode&&target.parentNode.removeChild(target),plainText?doPaste(view,target.value,null,event):doPaste(view,target.textContent,target.innerHTML,event)},50)}}function doPaste(view,text,html,event){var slice=parseFromClipboard(view,text,html,view.input.shiftKey,view.state.selection.$from);if(view.someProp("handlePaste",function(f){return f(view,event,slice||prosemirrorModel.Slice.empty)}))return!0;if(!slice)return!1;var singleNode=sliceSingleNode(slice),tr=singleNode?view.state.tr.replaceSelectionWith(singleNode,view.input.shiftKey):view.state.tr.replaceSelection(slice);return view.dispatch(tr.scrollIntoView().setMeta("paste",!0).setMeta("uiEvent","paste")),!0}editHandlers.paste=function(view,_event){var event=_event;if(!(view.composing&&!android)){var data=brokenClipboardAPI?null:event.clipboardData;data&&doPaste(view,data.getData("text/plain"),data.getData("text/html"),event)?event.preventDefault():capturePaste(view,event)}};var Dragging=_createClass(function Dragging2(slice,move){_classCallCheck(this,Dragging2),this.slice=slice,this.move=move}),dragCopyModifier=mac?"altKey":"ctrlKey";handlers.dragstart=function(view,_event){var event=_event,mouseDown=view.input.mouseDown;if(mouseDown&&mouseDown.done(),!!event.dataTransfer){var sel=view.state.selection,pos=sel.empty?null:view.posAtCoords(eventCoords(event));if(!(pos&&pos.pos>=sel.from&&pos.pos<=(sel instanceof prosemirrorState.NodeSelection?sel.to-1:sel.to))){if(mouseDown&&mouseDown.mightDrag)view.dispatch(view.state.tr.setSelection(prosemirrorState.NodeSelection.create(view.state.doc,mouseDown.mightDrag.pos)));else if(event.target&&event.target.nodeType==1){var desc=view.docView.nearestDesc(event.target,!0);desc&&desc.node.type.spec.draggable&&desc!=view.docView&&view.dispatch(view.state.tr.setSelection(prosemirrorState.NodeSelection.create(view.state.doc,desc.posBefore)))}}var slice=view.state.selection.content(),_serializeForClipboar2=serializeForClipboard(view,slice),dom=_serializeForClipboar2.dom,text=_serializeForClipboar2.text;event.dataTransfer.clearData(),event.dataTransfer.setData(brokenClipboardAPI?"Text":"text/html",dom.innerHTML),event.dataTransfer.effectAllowed="copyMove",brokenClipboardAPI||event.dataTransfer.setData("text/plain",text),view.dragging=new Dragging(slice,!event[dragCopyModifier])}},handlers.dragend=function(view){var dragging=view.dragging;window.setTimeout(function(){view.dragging==dragging&&(view.dragging=null)},50)},editHandlers.dragover=editHandlers.dragenter=function(_,e){return e.preventDefault()},editHandlers.drop=function(view,_event){var event=_event,dragging=view.dragging;if(view.dragging=null,!!event.dataTransfer){var eventPos=view.posAtCoords(eventCoords(event));if(!!eventPos){var $mouse=view.state.doc.resolve(eventPos.pos);if(!!$mouse){var slice=dragging&&dragging.slice;slice?view.someProp("transformPasted",function(f){slice=f(slice)}):slice=parseFromClipboard(view,event.dataTransfer.getData(brokenClipboardAPI?"Text":"text/plain"),brokenClipboardAPI?null:event.dataTransfer.getData("text/html"),!1,$mouse);var move=!!(dragging&&!event[dragCopyModifier]);if(view.someProp("handleDrop",function(f){return f(view,event,slice||prosemirrorModel.Slice.empty,move)})){event.preventDefault();return}if(!!slice){event.preventDefault();var insertPos=slice?prosemirrorTransform.dropPoint(view.state.doc,$mouse.pos,slice):$mouse.pos;insertPos==null&&(insertPos=$mouse.pos);var tr=view.state.tr;move&&tr.deleteSelection();var pos=tr.mapping.map(insertPos),isNode=slice.openStart==0&&slice.openEnd==0&&slice.content.childCount==1,beforeInsert=tr.doc;if(isNode?tr.replaceRangeWith(pos,pos,slice.content.firstChild):tr.replaceRange(pos,pos,slice),!tr.doc.eq(beforeInsert)){var $pos=tr.doc.resolve(pos);if(isNode&&prosemirrorState.NodeSelection.isSelectable(slice.content.firstChild)&&$pos.nodeAfter&&$pos.nodeAfter.sameMarkup(slice.content.firstChild))tr.setSelection(new prosemirrorState.NodeSelection($pos));else{var end=tr.mapping.map(insertPos);tr.mapping.maps[tr.mapping.maps.length-1].forEach(function(_from,_to,_newFrom,newTo){return end=newTo}),tr.setSelection(selectionBetween(view,$pos,tr.doc.resolve(end)))}view.focus(),view.dispatch(tr.setMeta("uiEvent","drop"))}}}}}},handlers.focus=function(view){view.focused||(view.domObserver.stop(),view.dom.classList.add("ProseMirror-focused"),view.domObserver.start(),view.focused=!0,setTimeout(function(){view.docView&&view.hasFocus()&&!view.domObserver.currentSelection.eq(view.domSelection())&&selectionToDOM(view)},20))},handlers.blur=function(view,_event){var event=_event;view.focused&&(view.domObserver.stop(),view.dom.classList.remove("ProseMirror-focused"),view.domObserver.start(),event.relatedTarget&&view.dom.contains(event.relatedTarget)&&view.domObserver.currentSelection.clear(),view.focused=!1)},handlers.beforeinput=function(view,_event){var event=_event;if(chrome&&android&&event.inputType=="deleteContentBackward"){view.domObserver.flushSoon();var domChangeCount=view.input.domChangeCount;setTimeout(function(){if(view.input.domChangeCount==domChangeCount&&(view.dom.blur(),view.focus(),!view.someProp("handleKeyDown",function(f){return f(view,keyEvent(8,"Backspace"))}))){var $cursor=view.state.selection.$cursor;$cursor&&$cursor.pos>0&&view.dispatch(view.state.tr.delete($cursor.pos-1,$cursor.pos).scrollIntoView())}},50)}};for(var prop in editHandlers)handlers[prop]=editHandlers[prop];function compareObjs(a,b){if(a==b)return!0;for(var p in a)if(a[p]!==b[p])return!1;for(var _p in b)if(!(_p in a))return!1;return!0}var WidgetType=function(){function WidgetType2(toDOM,spec){_classCallCheck(this,WidgetType2),this.toDOM=toDOM,this.spec=spec||noSpec,this.side=this.spec.side||0}return _createClass(WidgetType2,[{key:"map",value:function(mapping,span,offset,oldOffset){var _mapping$mapResult=mapping.mapResult(span.from+oldOffset,this.side<0?-1:1),pos=_mapping$mapResult.pos,deleted=_mapping$mapResult.deleted;return deleted?null:new Decoration(pos-offset,pos-offset,this)}},{key:"valid",value:function(){return!0}},{key:"eq",value:function(other){return this==other||other instanceof WidgetType2&&(this.spec.key&&this.spec.key==other.spec.key||this.toDOM==other.toDOM&&compareObjs(this.spec,other.spec))}},{key:"destroy",value:function(node){this.spec.destroy&&this.spec.destroy(node)}}]),WidgetType2}(),InlineType=function(){function InlineType2(attrs,spec){_classCallCheck(this,InlineType2),this.attrs=attrs,this.spec=spec||noSpec}return _createClass(InlineType2,[{key:"map",value:function(mapping,span,offset,oldOffset){var from=mapping.map(span.from+oldOffset,this.spec.inclusiveStart?-1:1)-offset,to=mapping.map(span.to+oldOffset,this.spec.inclusiveEnd?1:-1)-offset;return from>=to?null:new Decoration(from,to,this)}},{key:"valid",value:function(_,span){return span.from<span.to}},{key:"eq",value:function(other){return this==other||other instanceof InlineType2&&compareObjs(this.attrs,other.attrs)&&compareObjs(this.spec,other.spec)}},{key:"destroy",value:function(){}}],[{key:"is",value:function(span){return span.type instanceof InlineType2}}]),InlineType2}(),NodeType=function(){function NodeType2(attrs,spec){_classCallCheck(this,NodeType2),this.attrs=attrs,this.spec=spec||noSpec}return _createClass(NodeType2,[{key:"map",value:function(mapping,span,offset,oldOffset){var from=mapping.mapResult(span.from+oldOffset,1);if(from.deleted)return null;var to=mapping.mapResult(span.to+oldOffset,-1);return to.deleted||to.pos<=from.pos?null:new Decoration(from.pos-offset,to.pos-offset,this)}},{key:"valid",value:function(node,span){var _node$content$findInd=node.content.findIndex(span.from),index=_node$content$findInd.index,offset=_node$content$findInd.offset,child;return offset==span.from&&!(child=node.child(index)).isText&&offset+child.nodeSize==span.to}},{key:"eq",value:function(other){return this==other||other instanceof NodeType2&&compareObjs(this.attrs,other.attrs)&&compareObjs(this.spec,other.spec)}},{key:"destroy",value:function(){}}]),NodeType2}(),Decoration=function(){function Decoration2(from,to,type){_classCallCheck(this,Decoration2),this.from=from,this.to=to,this.type=type}return _createClass(Decoration2,[{key:"copy",value:function(from,to){return new Decoration2(from,to,this.type)}},{key:"eq",value:function(other){var offset=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return this.type.eq(other.type)&&this.from+offset==other.from&&this.to+offset==other.to}},{key:"map",value:function(mapping,offset,oldOffset){return this.type.map(mapping,this,offset,oldOffset)}},{key:"spec",get:function(){return this.type.spec}},{key:"inline",get:function(){return this.type instanceof InlineType}}],[{key:"widget",value:function(pos,toDOM,spec){return new Decoration2(pos,pos,new WidgetType(toDOM,spec))}},{key:"inline",value:function(from,to,attrs,spec){return new Decoration2(from,to,new InlineType(attrs,spec))}},{key:"node",value:function(from,to,attrs,spec){return new Decoration2(from,to,new NodeType(attrs,spec))}}]),Decoration2}(),none=[],noSpec={},DecorationSet=function(){function DecorationSet2(local,children){_classCallCheck(this,DecorationSet2),this.local=local.length?local:none,this.children=children.length?children:none}return _createClass(DecorationSet2,[{key:"find",value:function(start,end,predicate){var result=[];return this.findInner(start==null?0:start,end==null?1e9:end,result,0,predicate),result}},{key:"findInner",value:function(start,end,result,offset,predicate){for(var i=0;i<this.local.length;i++){var span=this.local[i];span.from<=end&&span.to>=start&&(!predicate||predicate(span.spec))&&result.push(span.copy(span.from+offset,span.to+offset))}for(var _i5=0;_i5<this.children.length;_i5+=3)if(this.children[_i5]<end&&this.children[_i5+1]>start){var childOff=this.children[_i5]+1;this.children[_i5+2].findInner(start-childOff,end-childOff,result,offset+childOff,predicate)}}},{key:"map",value:function(mapping,doc2,options){return this==empty||mapping.maps.length==0?this:this.mapInner(mapping,doc2,0,0,options||noSpec)}},{key:"mapInner",value:function(mapping,node,offset,oldOffset,options){for(var newLocal,i=0;i<this.local.length;i++){var mapped=this.local[i].map(mapping,offset,oldOffset);mapped&&mapped.type.valid(node,mapped)?(newLocal||(newLocal=[])).push(mapped):options.onRemove&&options.onRemove(this.local[i].spec)}return this.children.length?mapChildren(this.children,newLocal||[],mapping,node,offset,oldOffset,options):newLocal?new DecorationSet2(newLocal.sort(byPos),none):empty}},{key:"add",value:function(doc2,decorations){return decorations.length?this==empty?DecorationSet2.create(doc2,decorations):this.addInner(doc2,decorations,0):this}},{key:"addInner",value:function(doc2,decorations,offset){var _this10=this,children,childIndex=0;doc2.forEach(function(childNode,childOffset){var baseOffset=childOffset+offset,found;if(!!(found=takeSpansForNode(decorations,childNode,baseOffset))){for(children||(children=_this10.children.slice());childIndex<children.length&&children[childIndex]<childOffset;)childIndex+=3;children[childIndex]==childOffset?children[childIndex+2]=children[childIndex+2].addInner(childNode,found,baseOffset+1):children.splice(childIndex,0,childOffset,childOffset+childNode.nodeSize,buildTree(found,childNode,baseOffset+1,noSpec)),childIndex+=3}});for(var local=moveSpans(childIndex?withoutNulls(decorations):decorations,-offset),i=0;i<local.length;i++)local[i].type.valid(doc2,local[i])||local.splice(i--,1);return new DecorationSet2(local.length?this.local.concat(local).sort(byPos):this.local,children||this.children)}},{key:"remove",value:function(decorations){return decorations.length==0||this==empty?this:this.removeInner(decorations,0)}},{key:"removeInner",value:function(decorations,offset){for(var children=this.children,local=this.local,i=0;i<children.length;i+=3){for(var found=void 0,from=children[i]+offset,to=children[i+1]+offset,j=0,span;j<decorations.length;j++)(span=decorations[j])&&span.from>from&&span.to<to&&(decorations[j]=null,(found||(found=[])).push(span));if(!!found){children==this.children&&(children=this.children.slice());var removed=children[i+2].removeInner(found,from+1);removed!=empty?children[i+2]=removed:(children.splice(i,3),i-=3)}}if(local.length){for(var _i6=0,_span;_i6<decorations.length;_i6++)if(_span=decorations[_i6])for(var _j2=0;_j2<local.length;_j2++)local[_j2].eq(_span,offset)&&(local==this.local&&(local=this.local.slice()),local.splice(_j2--,1))}return children==this.children&&local==this.local?this:local.length||children.length?new DecorationSet2(local,children):empty}},{key:"forChild",value:function(offset,node){if(this==empty)return this;if(node.isLeaf)return DecorationSet2.empty;for(var child,local,i=0;i<this.children.length;i+=3)if(this.children[i]>=offset){this.children[i]==offset&&(child=this.children[i+2]);break}for(var start=offset+1,end=start+node.content.size,_i7=0;_i7<this.local.length;_i7++){var dec=this.local[_i7];if(dec.from<end&&dec.to>start&&dec.type instanceof InlineType){var from=Math.max(start,dec.from)-start,to=Math.min(end,dec.to)-start;from<to&&(local||(local=[])).push(dec.copy(from,to))}}if(local){var localSet=new DecorationSet2(local.sort(byPos),none);return child?new DecorationGroup([localSet,child]):localSet}return child||empty}},{key:"eq",value:function(other){if(this==other)return!0;if(!(other instanceof DecorationSet2)||this.local.length!=other.local.length||this.children.length!=other.children.length)return!1;for(var i=0;i<this.local.length;i++)if(!this.local[i].eq(other.local[i]))return!1;for(var _i8=0;_i8<this.children.length;_i8+=3)if(this.children[_i8]!=other.children[_i8]||this.children[_i8+1]!=other.children[_i8+1]||!this.children[_i8+2].eq(other.children[_i8+2]))return!1;return!0}},{key:"locals",value:function(node){return removeOverlap(this.localsInner(node))}},{key:"localsInner",value:function(node){if(this==empty)return none;if(node.inlineContent||!this.local.some(InlineType.is))return this.local;for(var result=[],i=0;i<this.local.length;i++)this.local[i].type instanceof InlineType||result.push(this.local[i]);return result}}],[{key:"create",value:function(doc2,decorations){return decorations.length?buildTree(decorations,doc2,0,noSpec):empty}}]),DecorationSet2}();DecorationSet.empty=new DecorationSet([],[]),DecorationSet.removeOverlap=removeOverlap;var empty=DecorationSet.empty,DecorationGroup=function(){function DecorationGroup2(members){_classCallCheck(this,DecorationGroup2),this.members=members}return _createClass(DecorationGroup2,[{key:"map",value:function(mapping,doc2){var mappedDecos=this.members.map(function(member){return member.map(mapping,doc2,noSpec)});return DecorationGroup2.from(mappedDecos)}},{key:"forChild",value:function(offset,child){if(child.isLeaf)return DecorationSet.empty;for(var found=[],i=0;i<this.members.length;i++){var result=this.members[i].forChild(offset,child);result!=empty&&(result instanceof DecorationGroup2?found=found.concat(result.members):found.push(result))}return DecorationGroup2.from(found)}},{key:"eq",value:function(other){if(!(other instanceof DecorationGroup2)||other.members.length!=this.members.length)return!1;for(var i=0;i<this.members.length;i++)if(!this.members[i].eq(other.members[i]))return!1;return!0}},{key:"locals",value:function(node){for(var result,sorted=!0,i=0;i<this.members.length;i++){var locals2=this.members[i].localsInner(node);if(!!locals2.length)if(!result)result=locals2;else{sorted&&(result=result.slice(),sorted=!1);for(var j=0;j<locals2.length;j++)result.push(locals2[j])}}return result?removeOverlap(sorted?result:result.sort(byPos)):none}}],[{key:"from",value:function(members){switch(members.length){case 0:return empty;case 1:return members[0];default:return new DecorationGroup2(members)}}}]),DecorationGroup2}();function mapChildren(oldChildren,newLocal,mapping,node,offset,oldOffset,options){for(var children=oldChildren.slice(),shift=function(oldStart,oldEnd,newStart,newEnd){for(var i2=0;i2<children.length;i2+=3){var end=children[i2+1],dSize=void 0;if(!(end<0||oldStart>end+oldOffset)){var start=children[i2]+oldOffset;oldEnd>=start?children[i2+1]=oldStart<=start?-2:-1:newStart>=offset&&(dSize=newEnd-newStart-(oldEnd-oldStart))&&(children[i2]+=dSize,children[i2+1]+=dSize)}}},i=0;i<mapping.maps.length;i++)mapping.maps[i].forEach(shift);for(var mustRebuild=!1,_i9=0;_i9<children.length;_i9+=3)if(children[_i9+1]<0){if(children[_i9+1]==-2){mustRebuild=!0,children[_i9+1]=-1;continue}var from=mapping.map(oldChildren[_i9]+oldOffset),fromLocal=from-offset;if(fromLocal<0||fromLocal>=node.content.size){mustRebuild=!0;continue}var to=mapping.map(oldChildren[_i9+1]+oldOffset,-1),toLocal=to-offset,_node$content$findInd2=node.content.findIndex(fromLocal),index=_node$content$findInd2.index,childOffset=_node$content$findInd2.offset,childNode=node.maybeChild(index);if(childNode&&childOffset==fromLocal&&childOffset+childNode.nodeSize==toLocal){var mapped=children[_i9+2].mapInner(mapping,childNode,from+1,oldChildren[_i9]+oldOffset+1,options);mapped!=empty?(children[_i9]=fromLocal,children[_i9+1]=toLocal,children[_i9+2]=mapped):(children[_i9+1]=-2,mustRebuild=!0)}else mustRebuild=!0}if(mustRebuild){var decorations=mapAndGatherRemainingDecorations(children,oldChildren,newLocal,mapping,offset,oldOffset,options),built=buildTree(decorations,node,0,options);newLocal=built.local;for(var _i10=0;_i10<children.length;_i10+=3)children[_i10+1]<0&&(children.splice(_i10,3),_i10-=3);for(var _i11=0,j=0;_i11<built.children.length;_i11+=3){for(var _from2=built.children[_i11];j<children.length&&children[j]<_from2;)j+=3;children.splice(j,0,built.children[_i11],built.children[_i11+1],built.children[_i11+2])}}return new DecorationSet(newLocal.sort(byPos),children)}function moveSpans(spans,offset){if(!offset||!spans.length)return spans;for(var result=[],i=0;i<spans.length;i++){var span=spans[i];result.push(new Decoration(span.from+offset,span.to+offset,span.type))}return result}function mapAndGatherRemainingDecorations(children,oldChildren,decorations,mapping,offset,oldOffset,options){function gather(set,oldOffset2){for(var i2=0;i2<set.local.length;i2++){var mapped=set.local[i2].map(mapping,offset,oldOffset2);mapped?decorations.push(mapped):options.onRemove&&options.onRemove(set.local[i2].spec)}for(var _i12=0;_i12<set.children.length;_i12+=3)gather(set.children[_i12+2],set.children[_i12]+oldOffset2+1)}for(var i=0;i<children.length;i+=3)children[i+1]==-1&&gather(children[i+2],oldChildren[i]+oldOffset+1);return decorations}function takeSpansForNode(spans,node,offset){if(node.isLeaf)return null;for(var end=offset+node.nodeSize,found=null,i=0,span;i<spans.length;i++)(span=spans[i])&&span.from>offset&&span.to<end&&((found||(found=[])).push(span),spans[i]=null);return found}function withoutNulls(array){for(var result=[],i=0;i<array.length;i++)array[i]!=null&&result.push(array[i]);return result}function buildTree(spans,node,offset,options){var children=[],hasNulls=!1;node.forEach(function(childNode,localStart){var found=takeSpansForNode(spans,childNode,localStart+offset);if(found){hasNulls=!0;var subtree=buildTree(found,childNode,offset+localStart+1,options);subtree!=empty&&children.push(localStart,localStart+childNode.nodeSize,subtree)}});for(var locals=moveSpans(hasNulls?withoutNulls(spans):spans,-offset).sort(byPos),i=0;i<locals.length;i++)locals[i].type.valid(node,locals[i])||(options.onRemove&&options.onRemove(locals[i].spec),locals.splice(i--,1));return locals.length||children.length?new DecorationSet(locals,children):empty}function byPos(a,b){return a.from-b.from||a.to-b.to}function removeOverlap(spans){for(var working=spans,i=0;i<working.length-1;i++){var span=working[i];if(span.from!=span.to)for(var j=i+1;j<working.length;j++){var next=working[j];if(next.from==span.from){next.to!=span.to&&(working==spans&&(working=spans.slice()),working[j]=next.copy(next.from,span.to),insertAhead(working,j+1,next.copy(span.to,next.to)));continue}else{next.from<span.to&&(working==spans&&(working=spans.slice()),working[i]=span.copy(span.from,next.from),insertAhead(working,j,span.copy(next.from,span.to)));break}}}return working}function insertAhead(array,i,deco){for(;i<array.length&&byPos(deco,array[i])>0;)i++;array.splice(i,0,deco)}function viewDecorations(view){var found=[];return view.someProp("decorations",function(f){var result=f(view.state);result&&result!=empty&&found.push(result)}),view.cursorWrapper&&found.push(DecorationSet.create(view.state.doc,[view.cursorWrapper.deco])),DecorationGroup.from(found)}var observeOptions={childList:!0,characterData:!0,characterDataOldValue:!0,attributes:!0,attributeOldValue:!0,subtree:!0},useCharData=ie&&ie_version<=11,SelectionState=function(){function SelectionState2(){_classCallCheck(this,SelectionState2),this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}return _createClass(SelectionState2,[{key:"set",value:function(sel){this.anchorNode=sel.anchorNode,this.anchorOffset=sel.anchorOffset,this.focusNode=sel.focusNode,this.focusOffset=sel.focusOffset}},{key:"clear",value:function(){this.anchorNode=this.focusNode=null}},{key:"eq",value:function(sel){return sel.anchorNode==this.anchorNode&&sel.anchorOffset==this.anchorOffset&&sel.focusNode==this.focusNode&&sel.focusOffset==this.focusOffset}}]),SelectionState2}(),DOMObserver=function(){function DOMObserver2(view,handleDOMChange){var _this11=this;_classCallCheck(this,DOMObserver2),this.view=view,this.handleDOMChange=handleDOMChange,this.queue=[],this.flushingSoon=-1,this.observer=null,this.currentSelection=new SelectionState,this.onCharData=null,this.suppressingSelectionUpdates=!1,this.observer=window.MutationObserver&&new window.MutationObserver(function(mutations){for(var i=0;i<mutations.length;i++)_this11.queue.push(mutations[i]);ie&&ie_version<=11&&mutations.some(function(m){return m.type=="childList"&&m.removedNodes.length||m.type=="characterData"&&m.oldValue.length>m.target.nodeValue.length})?_this11.flushSoon():_this11.flush()}),useCharData&&(this.onCharData=function(e){_this11.queue.push({target:e.target,type:"characterData",oldValue:e.prevValue}),_this11.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this)}return _createClass(DOMObserver2,[{key:"flushSoon",value:function(){var _this12=this;this.flushingSoon<0&&(this.flushingSoon=window.setTimeout(function(){_this12.flushingSoon=-1,_this12.flush()},20))}},{key:"forceFlush",value:function(){this.flushingSoon>-1&&(window.clearTimeout(this.flushingSoon),this.flushingSoon=-1,this.flush())}},{key:"start",value:function(){this.observer&&(this.observer.takeRecords(),this.observer.observe(this.view.dom,observeOptions)),this.onCharData&&this.view.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.connectSelection()}},{key:"stop",value:function(){var _this13=this;if(this.observer){var take=this.observer.takeRecords();if(take.length){for(var i=0;i<take.length;i++)this.queue.push(take[i]);window.setTimeout(function(){return _this13.flush()},20)}this.observer.disconnect()}this.onCharData&&this.view.dom.removeEventListener("DOMCharacterDataModified",this.onCharData),this.disconnectSelection()}},{key:"connectSelection",value:function(){this.view.dom.ownerDocument.addEventListener("selectionchange",this.onSelectionChange)}},{key:"disconnectSelection",value:function(){this.view.dom.ownerDocument.removeEventListener("selectionchange",this.onSelectionChange)}},{key:"suppressSelectionUpdates",value:function(){var _this14=this;this.suppressingSelectionUpdates=!0,setTimeout(function(){return _this14.suppressingSelectionUpdates=!1},50)}},{key:"onSelectionChange",value:function(){if(!!hasFocusAndSelection(this.view)){if(this.suppressingSelectionUpdates)return selectionToDOM(this.view);if(ie&&ie_version<=11&&!this.view.state.selection.empty){var sel=this.view.domSelection();if(sel.focusNode&&isEquivalentPosition(sel.focusNode,sel.focusOffset,sel.anchorNode,sel.anchorOffset))return this.flushSoon()}this.flush()}}},{key:"setCurSelection",value:function(){this.currentSelection.set(this.view.domSelection())}},{key:"ignoreSelectionChange",value:function(sel){if(sel.rangeCount==0)return!0;var container=sel.getRangeAt(0).commonAncestorContainer,desc=this.view.docView.nearestDesc(container);if(desc&&desc.ignoreMutation({type:"selection",target:container.nodeType==3?container.parentNode:container}))return this.setCurSelection(),!0}},{key:"flush",value:function(){if(!(!this.view.docView||this.flushingSoon>-1)){var mutations=this.observer?this.observer.takeRecords():[];this.queue.length&&(mutations=this.queue.concat(mutations),this.queue.length=0);var sel=this.view.domSelection(),newSel=!this.suppressingSelectionUpdates&&!this.currentSelection.eq(sel)&&hasFocusAndSelection(this.view)&&!this.ignoreSelectionChange(sel),from=-1,to=-1,typeOver=!1,added=[];if(this.view.editable)for(var i=0;i<mutations.length;i++){var result=this.registerMutation(mutations[i],added);result&&(from=from<0?result.from:Math.min(result.from,from),to=to<0?result.to:Math.max(result.to,to),result.typeOver&&(typeOver=!0))}if(gecko&&added.length>1){var brs=added.filter(function(n){return n.nodeName=="BR"});if(brs.length==2){var a=brs[0],b=brs[1];a.parentNode&&a.parentNode.parentNode==b.parentNode?b.remove():a.remove()}}(from>-1||newSel)&&(from>-1&&(this.view.docView.markDirty(from,to),checkCSS(this.view)),this.handleDOMChange(from,to,typeOver,added),this.view.docView&&this.view.docView.dirty?this.view.updateState(this.view.state):this.currentSelection.eq(sel)||selectionToDOM(this.view),this.currentSelection.set(sel))}}},{key:"registerMutation",value:function(mut,added){if(added.indexOf(mut.target)>-1)return null;var desc=this.view.docView.nearestDesc(mut.target);if(mut.type=="attributes"&&(desc==this.view.docView||mut.attributeName=="contenteditable"||mut.attributeName=="style"&&!mut.oldValue&&!mut.target.getAttribute("style"))||!desc||desc.ignoreMutation(mut))return null;if(mut.type=="childList"){for(var i=0;i<mut.addedNodes.length;i++)added.push(mut.addedNodes[i]);if(desc.contentDOM&&desc.contentDOM!=desc.dom&&!desc.contentDOM.contains(mut.target))return{from:desc.posBefore,to:desc.posAfter};var prev=mut.previousSibling,next=mut.nextSibling;if(ie&&ie_version<=11&&mut.addedNodes.length)for(var _i13=0;_i13<mut.addedNodes.length;_i13++){var _mut$addedNodes$_i=mut.addedNodes[_i13],previousSibling=_mut$addedNodes$_i.previousSibling,nextSibling=_mut$addedNodes$_i.nextSibling;(!previousSibling||Array.prototype.indexOf.call(mut.addedNodes,previousSibling)<0)&&(prev=previousSibling),(!nextSibling||Array.prototype.indexOf.call(mut.addedNodes,nextSibling)<0)&&(next=nextSibling)}var fromOffset=prev&&prev.parentNode==mut.target?domIndex(prev)+1:0,from=desc.localPosFromDOM(mut.target,fromOffset,-1),toOffset=next&&next.parentNode==mut.target?domIndex(next):mut.target.childNodes.length,to=desc.localPosFromDOM(mut.target,toOffset,1);return{from,to}}else return mut.type=="attributes"?{from:desc.posAtStart-desc.border,to:desc.posAtEnd+desc.border}:{from:desc.posAtStart,to:desc.posAtEnd,typeOver:mut.target.nodeValue==mut.oldValue}}}]),DOMObserver2}(),cssChecked=!1;function checkCSS(view){cssChecked||(cssChecked=!0,getComputedStyle(view.dom).whiteSpace=="normal"&&console.warn("ProseMirror expects the CSS white-space property to be set, preferably to 'pre-wrap'. It is recommended to load style/prosemirror.css from the prosemirror-view package."))}function parseBetween(view,from_,to_){var _view$docView$parseRa=view.docView.parseRange(from_,to_),parent=_view$docView$parseRa.node,fromOffset=_view$docView$parseRa.fromOffset,toOffset=_view$docView$parseRa.toOffset,from=_view$docView$parseRa.from,to=_view$docView$parseRa.to,domSel=view.domSelection(),find,anchor=domSel.anchorNode;if(anchor&&view.dom.contains(anchor.nodeType==1?anchor:anchor.parentNode)&&(find=[{node:anchor,offset:domSel.anchorOffset}],selectionCollapsed(domSel)||find.push({node:domSel.focusNode,offset:domSel.focusOffset})),chrome&&view.input.lastKeyCode===8)for(var off=toOffset;off>fromOffset;off--){var node=parent.childNodes[off-1],desc=node.pmViewDesc;if(node.nodeName=="BR"&&!desc){toOffset=off;break}if(!desc||desc.size)break}var startDoc=view.state.doc,parser=view.someProp("domParser")||prosemirrorModel.DOMParser.fromSchema(view.state.schema),$from=startDoc.resolve(from),sel=null,doc2=parser.parse(parent,{topNode:$from.parent,topMatch:$from.parent.contentMatchAt($from.index()),topOpen:!0,from:fromOffset,to:toOffset,preserveWhitespace:$from.parent.type.whitespace=="pre"?"full":!0,findPositions:find,ruleFromNode,context:$from});if(find&&find[0].pos!=null){var _anchor=find[0].pos,head=find[1]&&find[1].pos;head==null&&(head=_anchor),sel={anchor:_anchor+from,head:head+from}}return{doc:doc2,sel,from,to}}function ruleFromNode(dom){var desc=dom.pmViewDesc;if(desc)return desc.parseRule();if(dom.nodeName=="BR"&&dom.parentNode){if(safari&&/^(ul|ol)$/i.test(dom.parentNode.nodeName)){var skip=document.createElement("div");return skip.appendChild(document.createElement("li")),{skip}}else if(dom.parentNode.lastChild==dom||safari&&/^(tr|table)$/i.test(dom.parentNode.nodeName))return{ignore:!0}}else if(dom.nodeName=="IMG"&&dom.getAttribute("mark-placeholder"))return{ignore:!0};return null}function readDOMChange(view,from,to,typeOver,addedNodes){if(from<0){var origin=view.input.lastSelectionTime>Date.now()-50?view.input.lastSelectionOrigin:null,newSel=selectionFromDOM(view,origin);if(newSel&&!view.state.selection.eq(newSel)){var _tr=view.state.tr.setSelection(newSel);origin=="pointer"?_tr.setMeta("pointer",!0):origin=="key"&&_tr.scrollIntoView(),view.dispatch(_tr)}return}var $before=view.state.doc.resolve(from),shared=$before.sharedDepth(to);from=$before.before(shared+1),to=view.state.doc.resolve(to).after(shared+1);var sel=view.state.selection,parse=parseBetween(view,from,to);if(chrome&&view.cursorWrapper&&parse.sel&&parse.sel.anchor==view.cursorWrapper.deco.from){var text=view.cursorWrapper.deco.type.toDOM.nextSibling,size=text&&text.nodeValue?text.nodeValue.length:1;parse.sel={anchor:parse.sel.anchor+size,head:parse.sel.anchor+size}}var doc2=view.state.doc,compare=doc2.slice(parse.from,parse.to),preferredPos,preferredSide;view.input.lastKeyCode===8&&Date.now()-100<view.input.lastKeyCodeTime?(preferredPos=view.state.selection.to,preferredSide="end"):(preferredPos=view.state.selection.from,preferredSide="start"),view.input.lastKeyCode=null;var change=findDiff(compare.content,parse.doc.content,parse.from,preferredPos,preferredSide);if((ios&&view.input.lastIOSEnter>Date.now()-225||android)&&addedNodes.some(function(n){return n.nodeName=="DIV"||n.nodeName=="P"})&&(!change||change.endA>=change.endB)&&view.someProp("handleKeyDown",function(f){return f(view,keyEvent(13,"Enter"))})){view.input.lastIOSEnter=0;return}if(!change)if(typeOver&&sel instanceof prosemirrorState.TextSelection&&!sel.empty&&sel.$head.sameParent(sel.$anchor)&&!view.composing&&!(parse.sel&&parse.sel.anchor!=parse.sel.head))change={start:sel.from,endA:sel.to,endB:sel.to};else{if(parse.sel){var _sel=resolveSelection(view,view.state.doc,parse.sel);_sel&&!_sel.eq(view.state.selection)&&view.dispatch(view.state.tr.setSelection(_sel))}return}view.input.domChangeCount++,view.state.selection.from<view.state.selection.to&&change.start==change.endB&&view.state.selection instanceof prosemirrorState.TextSelection&&(change.start>view.state.selection.from&&change.start<=view.state.selection.from+2&&view.state.selection.from>=parse.from?change.start=view.state.selection.from:change.endA<view.state.selection.to&&change.endA>=view.state.selection.to-2&&view.state.selection.to<=parse.to&&(change.endB+=view.state.selection.to-change.endA,change.endA=view.state.selection.to)),ie&&ie_version<=11&&change.endB==change.start+1&&change.endA==change.start&&change.start>parse.from&&parse.doc.textBetween(change.start-parse.from-1,change.start-parse.from+1)==" \xA0"&&(change.start--,change.endA--,change.endB--);var $from=parse.doc.resolveNoCache(change.start-parse.from),$to=parse.doc.resolveNoCache(change.endB-parse.from),$fromA=doc2.resolve(change.start),inlineChange=$from.sameParent($to)&&$from.parent.inlineContent&&$fromA.end()>=change.endA,nextSel;if((ios&&view.input.lastIOSEnter>Date.now()-225&&(!inlineChange||addedNodes.some(function(n){return n.nodeName=="DIV"||n.nodeName=="P"}))||!inlineChange&&$from.pos<parse.doc.content.size&&(nextSel=prosemirrorState.Selection.findFrom(parse.doc.resolve($from.pos+1),1,!0))&&nextSel.head==$to.pos)&&view.someProp("handleKeyDown",function(f){return f(view,keyEvent(13,"Enter"))})){view.input.lastIOSEnter=0;return}if(view.state.selection.anchor>change.start&&looksLikeJoin(doc2,change.start,change.endA,$from,$to)&&view.someProp("handleKeyDown",function(f){return f(view,keyEvent(8,"Backspace"))})){android&&chrome&&view.domObserver.suppressSelectionUpdates();return}chrome&&android&&change.endB==change.start&&(view.input.lastAndroidDelete=Date.now()),android&&!inlineChange&&$from.start()!=$to.start()&&$to.parentOffset==0&&$from.depth==$to.depth&&parse.sel&&parse.sel.anchor==parse.sel.head&&parse.sel.head==change.endA&&(change.endB-=2,$to=parse.doc.resolveNoCache(change.endB-parse.from),setTimeout(function(){view.someProp("handleKeyDown",function(f){return f(view,keyEvent(13,"Enter"))})},20));var chFrom=change.start,chTo=change.endA,tr,storedMarks,markChange;if(inlineChange){if($from.pos==$to.pos)ie&&ie_version<=11&&$from.parentOffset==0&&(view.domObserver.suppressSelectionUpdates(),setTimeout(function(){return selectionToDOM(view)},20)),tr=view.state.tr.delete(chFrom,chTo),storedMarks=doc2.resolve(change.start).marksAcross(doc2.resolve(change.endA));else if(change.endA==change.endB&&(markChange=isMarkChange($from.parent.content.cut($from.parentOffset,$to.parentOffset),$fromA.parent.content.cut($fromA.parentOffset,change.endA-$fromA.start()))))tr=view.state.tr,markChange.type=="add"?tr.addMark(chFrom,chTo,markChange.mark):tr.removeMark(chFrom,chTo,markChange.mark);else if($from.parent.child($from.index()).isText&&$from.index()==$to.index()-($to.textOffset?0:1)){var _text=$from.parent.textBetween($from.parentOffset,$to.parentOffset);if(view.someProp("handleTextInput",function(f){return f(view,chFrom,chTo,_text)}))return;tr=view.state.tr.insertText(_text,chFrom,chTo)}}if(tr||(tr=view.state.tr.replace(chFrom,chTo,parse.doc.slice(change.start-parse.from,change.endB-parse.from))),parse.sel){var _sel2=resolveSelection(view,tr.doc,parse.sel);_sel2&&!(chrome&&android&&view.composing&&_sel2.empty&&(change.start!=change.endB||view.input.lastAndroidDelete<Date.now()-100)&&(_sel2.head==chFrom||_sel2.head==tr.mapping.map(chTo)-1)||ie&&_sel2.empty&&_sel2.head==chFrom)&&tr.setSelection(_sel2)}storedMarks&&tr.ensureMarks(storedMarks),view.dispatch(tr.scrollIntoView())}function resolveSelection(view,doc2,parsedSel){return Math.max(parsedSel.anchor,parsedSel.head)>doc2.content.size?null:selectionBetween(view,doc2.resolve(parsedSel.anchor),doc2.resolve(parsedSel.head))}function isMarkChange(cur,prev){for(var curMarks=cur.firstChild.marks,prevMarks=prev.firstChild.marks,added=curMarks,removed=prevMarks,type,mark,update,i=0;i<prevMarks.length;i++)added=prevMarks[i].removeFromSet(added);for(var _i14=0;_i14<curMarks.length;_i14++)removed=curMarks[_i14].removeFromSet(removed);if(added.length==1&&removed.length==0)mark=added[0],type="add",update=function(node){return node.mark(mark.addToSet(node.marks))};else if(added.length==0&&removed.length==1)mark=removed[0],type="remove",update=function(node){return node.mark(mark.removeFromSet(node.marks))};else return null;for(var updated=[],_i15=0;_i15<prev.childCount;_i15++)updated.push(update(prev.child(_i15)));if(prosemirrorModel.Fragment.from(updated).eq(cur))return{mark,type}}function looksLikeJoin(old,start,end,$newStart,$newEnd){if(!$newStart.parent.isTextblock||end-start<=$newEnd.pos-$newStart.pos||skipClosingAndOpening($newStart,!0,!1)<$newEnd.pos)return!1;var $start=old.resolve(start);if($start.parentOffset<$start.parent.content.size||!$start.parent.isTextblock)return!1;var $next=old.resolve(skipClosingAndOpening($start,!0,!0));return!$next.parent.isTextblock||$next.pos>end||skipClosingAndOpening($next,!0,!1)<end?!1:$newStart.parent.content.cut($newStart.parentOffset).eq($next.parent.content)}function skipClosingAndOpening($pos,fromEnd,mayOpen){for(var depth=$pos.depth,end=fromEnd?$pos.end():$pos.pos;depth>0&&(fromEnd||$pos.indexAfter(depth)==$pos.node(depth).childCount);)depth--,end++,fromEnd=!1;if(mayOpen)for(var next=$pos.node(depth).maybeChild($pos.indexAfter(depth));next&&!next.isLeaf;)next=next.firstChild,end++;return end}function findDiff(a,b,pos,preferredPos,preferredSide){var start=a.findDiffStart(b,pos);if(start==null)return null;var _a$findDiffEnd=a.findDiffEnd(b,pos+a.size,pos+b.size),endA=_a$findDiffEnd.a,endB=_a$findDiffEnd.b;if(preferredSide=="end"){var adjust=Math.max(0,start-Math.min(endA,endB));preferredPos-=endA+adjust-start}if(endA<start&&a.size<b.size){var move=preferredPos<=start&&preferredPos>=endA?start-preferredPos:0;start-=move,endB=start+(endB-endA),endA=start}else if(endB<start){var _move=preferredPos<=start&&preferredPos>=endB?start-preferredPos:0;start-=_move,endA=start+(endA-endB),endB=start}return{start,endA,endB}}var __serializeForClipboard=serializeForClipboard,__parseFromClipboard=parseFromClipboard,__endComposition=endComposition,EditorView=function(){function EditorView2(place,props){var _this15=this;_classCallCheck(this,EditorView2),this._root=null,this.focused=!1,this.trackWrites=null,this.mounted=!1,this.markCursor=null,this.cursorWrapper=null,this.lastSelectedViewDesc=void 0,this.input=new InputState,this.prevDirectPlugins=[],this.pluginViews=[],this.dragging=null,this._props=props,this.state=props.state,this.directPlugins=props.plugins||[],this.directPlugins.forEach(checkStateComponent),this.dispatch=this.dispatch.bind(this),this.dom=place&&place.mount||document.createElement("div"),place&&(place.appendChild?place.appendChild(this.dom):typeof place=="function"?place(this.dom):place.mount&&(this.mounted=!0)),this.editable=getEditable(this),updateCursorWrapper(this),this.nodeViews=buildNodeViews(this),this.docView=docViewDesc(this.state.doc,computeDocDeco(this),viewDecorations(this),this.dom,this),this.domObserver=new DOMObserver(this,function(from,to,typeOver,added){return readDOMChange(_this15,from,to,typeOver,added)}),this.domObserver.start(),initInput(this),this.updatePluginViews()}return _createClass(EditorView2,[{key:"composing",get:function(){return this.input.composing}},{key:"props",get:function(){if(this._props.state!=this.state){var prev=this._props;this._props={};for(var name in prev)this._props[name]=prev[name];this._props.state=this.state}return this._props}},{key:"update",value:function(props){props.handleDOMEvents!=this._props.handleDOMEvents&&ensureListeners(this),this._props=props,props.plugins&&(props.plugins.forEach(checkStateComponent),this.directPlugins=props.plugins),this.updateStateInner(props.state,!0)}},{key:"setProps",value:function(props){var updated={};for(var name in this._props)updated[name]=this._props[name];updated.state=this.state;for(var _name2 in props)updated[_name2]=props[_name2];this.update(updated)}},{key:"updateState",value:function(state){this.updateStateInner(state,this.state.plugins!=state.plugins)}},{key:"updateStateInner",value:function(state,reconfigured){var _this16=this,prev=this.state,redraw=!1,updateSel=!1;if(state.storedMarks&&this.composing&&(clearComposition(this),updateSel=!0),this.state=state,reconfigured){var nodeViews=buildNodeViews(this);changedNodeViews(nodeViews,this.nodeViews)&&(this.nodeViews=nodeViews,redraw=!0),ensureListeners(this)}this.editable=getEditable(this),updateCursorWrapper(this);var innerDeco=viewDecorations(this),outerDeco=computeDocDeco(this),scroll=reconfigured?"reset":state.scrollToSelection>prev.scrollToSelection?"to selection":"preserve",updateDoc=redraw||!this.docView.matchesNode(state.doc,outerDeco,innerDeco);(updateDoc||!state.selection.eq(prev.selection))&&(updateSel=!0);var oldScrollPos=scroll=="preserve"&&updateSel&&this.dom.style.overflowAnchor==null&&storeScrollPos(this);if(updateSel){this.domObserver.stop();var forceSelUpdate=updateDoc&&(ie||chrome)&&!this.composing&&!prev.selection.empty&&!state.selection.empty&&selectionContextChanged(prev.selection,state.selection);if(updateDoc){var chromeKludge=chrome?this.trackWrites=this.domSelection().focusNode:null;(redraw||!this.docView.update(state.doc,outerDeco,innerDeco,this))&&(this.docView.updateOuterDeco([]),this.docView.destroy(),this.docView=docViewDesc(state.doc,outerDeco,innerDeco,this.dom,this)),chromeKludge&&!this.trackWrites&&(forceSelUpdate=!0)}forceSelUpdate||!(this.input.mouseDown&&this.domObserver.currentSelection.eq(this.domSelection())&&anchorInRightPlace(this))?selectionToDOM(this,forceSelUpdate):(syncNodeSelection(this,state.selection),this.domObserver.setCurSelection()),this.domObserver.start()}if(this.updatePluginViews(prev),scroll=="reset")this.dom.scrollTop=0;else if(scroll=="to selection"){var startDOM=this.domSelection().focusNode;if(!this.someProp("handleScrollToSelection",function(f){return f(_this16)}))if(state.selection instanceof prosemirrorState.NodeSelection){var target=this.docView.domAfterPos(state.selection.from);target.nodeType==1&&scrollRectIntoView(this,target.getBoundingClientRect(),startDOM)}else scrollRectIntoView(this,this.coordsAtPos(state.selection.head,1),startDOM)}else oldScrollPos&&resetScrollPos(oldScrollPos)}},{key:"destroyPluginViews",value:function(){for(var view;view=this.pluginViews.pop();)view.destroy&&view.destroy()}},{key:"updatePluginViews",value:function(prevState){if(!prevState||prevState.plugins!=this.state.plugins||this.directPlugins!=this.prevDirectPlugins){this.prevDirectPlugins=this.directPlugins,this.destroyPluginViews();for(var i=0;i<this.directPlugins.length;i++){var plugin=this.directPlugins[i];plugin.spec.view&&this.pluginViews.push(plugin.spec.view(this))}for(var _i16=0;_i16<this.state.plugins.length;_i16++){var _plugin=this.state.plugins[_i16];_plugin.spec.view&&this.pluginViews.push(_plugin.spec.view(this))}}else for(var _i17=0;_i17<this.pluginViews.length;_i17++){var pluginView=this.pluginViews[_i17];pluginView.update&&pluginView.update(this,prevState)}}},{key:"someProp",value:function(propName,f){var prop2=this._props&&this._props[propName],value;if(prop2!=null&&(value=f?f(prop2):prop2))return value;for(var i=0;i<this.directPlugins.length;i++){var _prop=this.directPlugins[i].props[propName];if(_prop!=null&&(value=f?f(_prop):_prop))return value}var plugins=this.state.plugins;if(plugins)for(var _i18=0;_i18<plugins.length;_i18++){var _prop2=plugins[_i18].props[propName];if(_prop2!=null&&(value=f?f(_prop2):_prop2))return value}}},{key:"hasFocus",value:function(){return this.root.activeElement==this.dom}},{key:"focus",value:function(){this.domObserver.stop(),this.editable&&focusPreventScroll(this.dom),selectionToDOM(this),this.domObserver.start()}},{key:"root",get:function(){var _this17=this,cached=this._root;if(cached==null)for(var _loop4=function(search2){if(search2.nodeType==9||search2.nodeType==11&&search2.host)return search2.getSelection||(Object.getPrototypeOf(search2).getSelection=function(){return search2.ownerDocument.getSelection()}),{v:_this17._root=search2}},search=this.dom.parentNode;search;search=search.parentNode){var _ret3=_loop4(search);if(_typeof(_ret3)==="object")return _ret3.v}return cached||document}},{key:"posAtCoords",value:function(coords){return _posAtCoords(this,coords)}},{key:"coordsAtPos",value:function(pos){var side=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return _coordsAtPos(this,pos,side)}},{key:"domAtPos",value:function(pos){var side=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return this.docView.domFromPos(pos,side)}},{key:"nodeDOM",value:function(pos){var desc=this.docView.descAt(pos);return desc?desc.nodeDOM:null}},{key:"posAtDOM",value:function(node,offset){var bias=arguments.length>2&&arguments[2]!==void 0?arguments[2]:-1,pos=this.docView.posFromDOM(node,offset,bias);if(pos==null)throw new RangeError("DOM position not inside the editor");return pos}},{key:"endOfTextblock",value:function(dir,state){return _endOfTextblock(this,state||this.state,dir)}},{key:"destroy",value:function(){!this.docView||(destroyInput(this),this.destroyPluginViews(),this.mounted?(this.docView.update(this.state.doc,[],viewDecorations(this),this),this.dom.textContent=""):this.dom.parentNode&&this.dom.parentNode.removeChild(this.dom),this.docView.destroy(),this.docView=null)}},{key:"isDestroyed",get:function(){return this.docView==null}},{key:"dispatchEvent",value:function(event){return _dispatchEvent(this,event)}},{key:"dispatch",value:function(tr){var dispatchTransaction=this._props.dispatchTransaction;dispatchTransaction?dispatchTransaction.call(this,tr):this.updateState(this.state.apply(tr))}},{key:"domSelection",value:function(){return this.root.getSelection()}}]),EditorView2}();function computeDocDeco(view){var attrs=Object.create(null);return attrs.class="ProseMirror",attrs.contenteditable=String(view.editable),attrs.translate="no",view.someProp("attributes",function(value){if(typeof value=="function"&&(value=value(view.state)),value)for(var attr in value)attr=="class"&&(attrs.class+=" "+value[attr]),attr=="style"?attrs.style=(attrs.style?attrs.style+";":"")+value[attr]:!attrs[attr]&&attr!="contenteditable"&&attr!="nodeName"&&(attrs[attr]=String(value[attr]))}),[Decoration.node(0,view.state.doc.content.size,attrs)]}function updateCursorWrapper(view){if(view.markCursor){var dom=document.createElement("img");dom.className="ProseMirror-separator",dom.setAttribute("mark-placeholder","true"),dom.setAttribute("alt",""),view.cursorWrapper={dom,deco:Decoration.widget(view.state.selection.head,dom,{raw:!0,marks:view.markCursor})}}else view.cursorWrapper=null}function getEditable(view){return!view.someProp("editable",function(value){return value(view.state)===!1})}function selectionContextChanged(sel1,sel2){var depth=Math.min(sel1.$anchor.sharedDepth(sel1.head),sel2.$anchor.sharedDepth(sel2.head));return sel1.$anchor.start(depth)!=sel2.$anchor.start(depth)}function buildNodeViews(view){var result=Object.create(null);function add(obj){for(var _prop3 in obj)Object.prototype.hasOwnProperty.call(result,_prop3)||(result[_prop3]=obj[_prop3])}return view.someProp("nodeViews",add),view.someProp("markViews",add),result}function changedNodeViews(a,b){var nA=0,nB=0;for(var _prop4 in a){if(a[_prop4]!=b[_prop4])return!0;nA++}for(var _ in b)nB++;return nA!=nB}function checkStateComponent(plugin){if(plugin.spec.state||plugin.spec.filterTransaction||plugin.spec.appendTransaction)throw new RangeError("Plugins passed directly to the view must not have a state component")}exports.Decoration=Decoration,exports.DecorationSet=DecorationSet,exports.EditorView=EditorView,exports.__endComposition=__endComposition,exports.__parseFromClipboard=__parseFromClipboard,exports.__serializeForClipboard=__serializeForClipboard;

//# sourceMappingURL=f7096b92201667ed2eff.cjs.map